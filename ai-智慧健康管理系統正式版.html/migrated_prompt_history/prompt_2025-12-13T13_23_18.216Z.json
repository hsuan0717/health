[
  {
    "id": 0,
    "author": "user",
    "payload": {
      "type": "text",
      "text": "AI 智慧健康管理系統：核心程式邏輯描述\n一、 數據結構定義（Data Structures）\n系統必須定義三個主要的數據結構來儲存高中生每日的健康數據。\n1. 飲食數據結構 (DietData)\n此結構用於儲存 Gemini Vision 辨識與熱量估算後的數據： | 欄位名稱 | 資料型態 | 數據來源（功能） | 依據的來源資訊 | | :--- | :--- | :--- | :--- | | Date (日期) | Date | 手動輸入/系統時間 | | | CalorieIntake (總熱量) | Float | Gemini Vision 估算 | 熱量攝取是否過高或不足 | | VegRatio (蔬菜比例) | Float | Gemini Vision 辨識結果 | 蔬菜比例 | | ProteinRatio (蛋白質比例) | Float | Gemini Vision 辨識結果 | 蛋白質比例 | | StarchRatio (澱粉比例) | Float | Gemini Vision 辨識結果 | 澱粉比例 | | SugaryDrinksCount (含糖飲次數) | Integer | 手動輸入/Gemini Vision 辨識 | 含糖飲料出現次數 | | FriedFoodCount (油炸食物次數) | Integer | 手動輸入/Gemini Vision 辨識 | 油炸食物出現次數 |\n2. 運動數據結構 (ExerciseData)\n此結構用於儲存活動量與運動數據： | 欄位名稱 | 資料型態 | 數據來源（功能） | 依據的來源資訊 | | :--- | :--- | :--- | :--- | | Date (日期) | Date | 系統時間 | | | DailySteps (每日步數) | Integer | Google Fit / Apple Health | 記錄每日步數 | | ModerateExerciseMinutes (中等強度分鐘數) | Integer | Google Fit / Apple Health | 每週至少 3 次中等強度運動 | | TotalSittingMinutes (總久坐分鐘數) | Integer | Google Fit / Apple Health | 久坐 50 分鐘後起身活動 5 分鐘 |\n3. 睡眠數據結構 (SleepData)\n此結構用於儲存作息與睡眠數據： | 欄位名稱 | 資料型態 | 數據來源（功能） | 依據的來源資訊 | | :--- | :--- | :--- | :--- | | Date (日期) | Date | 系統時間 | | | BedTime (入睡時間) | Time | Google Fit 記錄/手動輸入 | 記錄每日入睡時間 | | WakeTime (起床時間) | Time | Google Fit 記錄/手動輸入 | 記錄每日起床時間 | | SleepDuration (睡眠總時數) | Float | Google Fit 分析 | 分析睡眠時數 |\n\n--------------------------------------------------------------------------------\n二、 核心分析邏輯函數（Core Analysis Functions）\n系統需定義三個主要的分析函數，用於評估數據與目標的達成度，並生成建議。\n1. 飲食分析函數 (AnalyzeDiet(DietData weekly_data))\n邏輯判斷 (IF/ELSE)\n目標標準 (Threshold)\n輸出結果/建議類型 (Output)\n營養比例檢查\nVegRatio < 0.5 OR ProteinRatio < 0.25\n建議採用「健康餐盤法」：1/2 蔬菜、1/4 蛋白質。\n含糖飲料檢查\n週平均 SugaryDrinksCount > (7 - 3) / 7 (即平均每天超過 0.57 次)\n提醒每週至少 3 天不喝含糖飲料。\n熱量異常檢查\nCalorieIntake 顯著高於或低於標準（需定義基準線）\n提醒熱量攝取過高或不足。\n2. 運動分析函數 (AnalyzeExercise(ExerciseData weekly_data))\n邏輯判斷 (IF/ELSE)\n目標標準 (Threshold)\n輸出結果/建議類型 (Output)\n步數達標檢查\n週平均 DailySteps < 8000\n提醒每日步數目標：8,000–10,000 步。\n強度檢查\n週總 ModerateExerciseMinutes < (3 * 60)\n提醒每週至少 3 次中等強度運動。\n久坐提醒\nTotalSittingMinutes 異常高（需定義基準線）\n建議久坐 50 分鐘後起身活動 5 分鐘。\n3. 睡眠分析函數 (AnalyzeSleep(SleepData weekly_data))\n邏輯判斷 (IF/ELSE)\n目標標準 (Threshold)\n輸出結果/建議類型 (Output)\n規律性檢查\n每日 BedTime / WakeTime 變化超過 60 分鐘\n提醒固定睡眠時間（23:00–07:00）。\n熬夜檢查\nBedTime > 23:30 (例如)\n提醒作息是否規律，避免熬夜。\n時數檢查\n週平均 SleepDuration < 7.5 小時（假設高中生所需時數）\n提醒平均睡眠時數不足。\n睡前習慣檢查\n若輸入欄位顯示睡前使用手機\n提醒睡前 30 分鐘不使用手機。\n\n--------------------------------------------------------------------------------\n三、 數據輸出與視覺化功能描述\n系統的輸出功能將資料處理結果轉化為可視化的報告與圖表。這部分程式碼將依賴圖表庫（如 Matplotlib 或 D3.js）來呈現結果。\n1. 報告生成函數 (GenerateWeeklyReport(all_data))\n• 功能： 呼叫所有分析函數的結果，並使用 ChatGPT（或內部自然語言生成模組）的邏輯生成文字摘要。\n• 輸出內容： 生成每週健康分析報告的文字內容。\n2. 圖表生成函數 (GenerateCharts(all_data))\n• 功能： 接收整理過的數據（由 Excel Copilot 邏輯處理後的結果），生成視覺化圖表。\n• 輸出圖表類型：\n    ◦ 每日步數折線圖： 視覺化呈現每日步數變化。\n    ◦ 營養比例圓餅圖： 呈現蔬菜、蛋白質、澱粉的比例。\n    ◦ 健康改善前後比較圖： 比較執行計畫前後的數據差異。\n3. 建議摘要輸出 (OutputAdviceSummary(all_results))\n• 功能： 將所有分析函數生成的建議（如「採用健康餐盤法」、「固定睡眠時間」 等）彙整成一個表格。\n• 輸出內容： AI 健康建議摘要表",
      "files": [],
      "fileUploads": [],
      "cMarkNode": {}
    },
    "createdTimestamp": 1765619281125
  },
  {
    "id": 1,
    "author": "model",
    "payload": {
      "type": "thinking",
      "text": "**Define Project Scope**\n\nI've clarified the project scope. The user needs a React app, \"AI 智慧健康管理系統,\" focusing on Diet, Exercise, and Sleep data, including analysis with specified thresholds and visualizations. I'm focusing on those three elements primarily.\n\n\n**Elaborate on Features**\n\nI've been drilling down on the specific features. It's a mobile-first React application targeting high school students, incorporating image-based diet tracking via Gemini Vision for food analysis with veg/protein/starch breakdown. Exercise and sleep tracking are also key, including analysis and reporting with Gemini AI, and data visualization using Recharts. Thresholds will be used for AI analysis to generate weekly reports. The tech stack will include React, TypeScript, Tailwind CSS, Recharts, and the Gemini SDK.\n\n\n**Planning Component Structure**\n\nNow I'm designing the app's internal structure. I'm focusing on `index.tsx` for the React root and `App.tsx` for layout and navigation. I'll need `types.ts` for data definitions, `constants.ts` for thresholds, and `geminiService.ts` for the API interactions. I'm thinking of components like `Dashboard`, `DietInput`, `ExerciseInput`, `SleepInput`, `ReportGenerator`, and `Navigation`.\n\n\\n\\n\n\nWith component structure roughly planned, I'm now drafting the interfaces needed for the daily data entries. I'll use `useState` for state management within the App, with data being passed down. For this prototype, in-memory state with some dummy data initially is fine, given time constraints.\n\n\n**Designing Data Interfaces**\n\nI'm now focusing on data handling and Gemini integration. Specifically, I'm working on prompts for image analysis and report generation using Gemini. For the UI, I'm defining a color scheme to create a fresh and healthy feel, and finalizing the layout for both mobile and desktop views. Finally, I've outlined a step-by-step implementation plan with `metadata.json` and `index.html` as the initial steps.\n\n\n**Refining Implementation Steps**\n\nI'm now revising my coding implementation plan. First, I'm loading Tailwind and the font. Next, I'll mount `App.tsx` in `index.tsx`. I'll define data structures in `types.ts`, and implement the Gemini services for food analysis and report generation using `@google/genai`. I'm designing reusable UI components, and charts with Recharts for displaying data. Finally, I'll create `App.tsx` to handle state and logic.\n\n\n**Adjust Chart Timezones**\n\nI'm now implementing the timezone adjustment in Recharts to make the demo display accurate time data. Also, I'm integrating the Gemini JSON output validation. I'm translating the analysis pseudo-code into actual functions. Finally, I'm refining the Gemini image analysis prompts to ensure they return strictly valid JSON objects.\n\n\n**Refining Gemini Integration**\n\nI'm now integrating the Gemini API key securely, using `process.env.API_KEY` as instructed. I'm also ensuring the analysis logic in functions like `AnalyzeDiet`, `AnalyzeExercise`, and `AnalyzeSleep` strictly follows the provided requirements (Health Plate, 8000 steps, etc.). I'm building a helper function, `generateHealthAdvice`, in `App.tsx` to handle these checks and generate the \"Advice Summary Table\".\n\n\n**Streamlining Component Logic**\n\nI'm now streamlining the data flow and UI rendering logic. I'm focusing on making `App.tsx` the central hub for state management and function calls. I will avoid using context and focus on making `App.tsx` the main handler for data and logic. The shared states will be passed to input components. I'm also ensuring type safety across the application using `types.ts`, and moving most AI-related stuff to `geminiService` for better organization.\n\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": 1765619281125,
    "doneTimestamp": 1765619304575
  },
  {
    "id": 2,
    "author": "model",
    "payload": {
      "type": "generationTable",
      "entries": [
        {
          "path": "metadata.json",
          "generationType": 0,
          "isDone": true,
          "description": "App metadata and permissions",
          "diffs": [
            {
              "target": "",
              "replacement": "{\n  \"name\": \"AI 智慧健康管理系統\",\n  \"description\": \"高中生全方位健康追蹤應用程式。整合飲食、運動與睡眠數據，利用 Gemini Vision 辨識飲食內容，並提供個人化健康建議與週報分析。\",\n  \"requestFramePermissions\": [\n    \"camera\"\n  ]\n}"
            }
          ]
        },
        {
          "path": "index.html",
          "generationType": 0,
          "isDone": true,
          "description": "Root HTML file with Tailwind and Font Awesome",
          "diffs": [
            {
              "target": "",
              "replacement": "<!DOCTYPE html>\n<html lang=\"zh-TW\">\n  <head>\n    <meta charset=\"utf-8\" />\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n    <title>AI 智慧健康管理系統</title>\n    <script src=\"https://cdn.tailwindcss.com\"></script>\n    <link href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css\" rel=\"stylesheet\">\n    <script>\n      tailwind.config = {\n        theme: {\n          extend: {\n            colors: {\n              primary: '#10B981', // Emerald 500\n              secondary: '#3B82F6', // Blue 500\n              accent: '#F59E0B', // Amber 500\n              background: '#F3F4F6', // Gray 100\n              surface: '#FFFFFF',\n            }\n          }\n        }\n      }\n    </script>\n    <style>\n      body {\n        font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;\n        background-color: #F3F4F6;\n      }\n      /* Hide scrollbar for Chrome, Safari and Opera */\n      .no-scrollbar::-webkit-scrollbar {\n          display: none;\n      }\n      /* Hide scrollbar for IE, Edge and Firefox */\n      .no-scrollbar {\n          -ms-overflow-style: none;  /* IE and Edge */\n          scrollbar-width: none;  /* Firefox */\n      }\n    </style>\n  </head>\n  <body>\n    <div id=\"root\"></div>\n  </body>\n</html>"
            }
          ]
        },
        {
          "path": "index.tsx",
          "generationType": 0,
          "isDone": true,
          "description": "React entry point",
          "diffs": [
            {
              "target": "",
              "replacement": "import React from 'react';\nimport ReactDOM from 'react-dom/client';\nimport App from './App';\n\nconst rootElement = document.getElementById('root');\nif (!rootElement) {\n  throw new Error(\"Could not find root element to mount to\");\n}\n\nconst root = ReactDOM.createRoot(rootElement);\nroot.render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>\n);"
            }
          ]
        },
        {
          "path": "types.ts",
          "generationType": 0,
          "isDone": true,
          "description": "Data structures for Diet, Exercise, and Sleep",
          "diffs": [
            {
              "target": "",
              "replacement": "export interface DietData {\n  id: string;\n  date: string; // YYYY-MM-DD\n  calorieIntake: number;\n  vegRatio: number; // 0.0 - 1.0\n  proteinRatio: number; // 0.0 - 1.0\n  starchRatio: number; // 0.0 - 1.0\n  sugaryDrinksCount: number;\n  friedFoodCount: number;\n  imageUrl?: string;\n}\n\nexport interface ExerciseData {\n  id: string;\n  date: string; // YYYY-MM-DD\n  dailySteps: number;\n  moderateExerciseMinutes: number;\n  totalSittingMinutes: number;\n}\n\nexport interface SleepData {\n  id: string;\n  date: string; // YYYY-MM-DD\n  bedTime: string; // HH:mm\n  wakeTime: string; // HH:mm\n  sleepDuration: number; // Hours (float)\n  usedPhoneBeforeBed: boolean;\n}\n\nexport interface AdviceItem {\n  category: 'Diet' | 'Exercise' | 'Sleep';\n  title: string;\n  description: string;\n  priority: 'High' | 'Medium' | 'Low';\n}\n\nexport interface WeeklyReport {\n  generatedAt: string;\n  summary: string;\n  adviceList: AdviceItem[];\n}\n"
            }
          ]
        },
        {
          "path": "services/geminiService.ts",
          "generationType": 0,
          "isDone": true,
          "description": "Gemini API integration for image analysis and reporting",
          "diffs": [
            {
              "target": "",
              "replacement": "import { GoogleGenAI, Type, Schema } from \"@google/genai\";\nimport { DietData, ExerciseData, SleepData, WeeklyReport, AdviceItem } from '../types';\n\nconst getClient = () => {\n  const apiKey = process.env.API_KEY;\n  if (!apiKey) {\n    throw new Error(\"API Key not found in environment variables\");\n  }\n  return new GoogleGenAI({ apiKey });\n};\n\n// --- Image Analysis for Diet ---\n\ninterface FoodAnalysisResult {\n  calorieIntake: number;\n  vegRatio: number;\n  proteinRatio: number;\n  starchRatio: number;\n  sugaryDrinksCount: number;\n  friedFoodCount: number;\n}\n\nexport const analyzeFoodImage = async (base64Image: string): Promise<FoodAnalysisResult> => {\n  const ai = getClient();\n  const modelId = \"gemini-2.5-flash\"; // Fast and capable for vision\n\n  const schema: Schema = {\n    type: Type.OBJECT,\n    properties: {\n      calorieIntake: { type: Type.NUMBER, description: \"Estimated total calories in kcal\" },\n      vegRatio: { type: Type.NUMBER, description: \"Ratio of vegetables (0.0 to 1.0)\" },\n      proteinRatio: { type: Type.NUMBER, description: \"Ratio of protein sources (0.0 to 1.0)\" },\n      starchRatio: { type: Type.NUMBER, description: \"Ratio of starch/carbs (0.0 to 1.0)\" },\n      sugaryDrinksCount: { type: Type.INTEGER, description: \"Count of sugary drinks visible (usually 0 or 1)\" },\n      friedFoodCount: { type: Type.INTEGER, description: \"Count of fried food items visible (usually 0 or 1)\" },\n    },\n    required: [\"calorieIntake\", \"vegRatio\", \"proteinRatio\", \"starchRatio\", \"sugaryDrinksCount\", \"friedFoodCount\"],\n  };\n\n  const prompt = `Analyze this food image for a high school student's health log. \n  Estimate the nutritional content based on the visible food. \n  Provide ratios for vegetables, protein, and starch (they should roughly sum to 1.0, but it's okay if not exact).\n  Identify if there are sugary drinks or fried foods.`;\n\n  try {\n    const response = await ai.models.generateContent({\n      model: modelId,\n      contents: {\n        parts: [\n            { inlineData: { mimeType: \"image/jpeg\", data: base64Image } },\n            { text: prompt }\n        ]\n      },\n      config: {\n        responseMimeType: \"application/json\",\n        responseSchema: schema,\n      },\n    });\n\n    const text = response.text;\n    if (!text) throw new Error(\"No response from Gemini\");\n    \n    return JSON.parse(text) as FoodAnalysisResult;\n  } catch (error) {\n    console.error(\"Gemini Image Analysis Error:\", error);\n    // Fallback or re-throw\n    throw error;\n  }\n};\n\n// --- Weekly Report Generation ---\n\nexport const generateWeeklyReportAI = async (\n  dietData: DietData[],\n  exerciseData: ExerciseData[],\n  sleepData: SleepData[],\n  manualAdvice: AdviceItem[]\n): Promise<string> => {\n  const ai = getClient();\n  const modelId = \"gemini-2.5-flash\"; \n\n  // Format data for the prompt\n  const dataSummary = {\n    diet: dietData.map(d => ({ date: d.date, cal: d.calorieIntake, veg: d.vegRatio, sugary: d.sugaryDrinksCount })),\n    exercise: exerciseData.map(e => ({ date: e.date, steps: e.dailySteps, modMin: e.moderateExerciseMinutes, sitting: e.totalSittingMinutes })),\n    sleep: sleepData.map(s => ({ date: s.date, duration: s.sleepDuration, bedTime: s.bedTime, phone: s.usedPhoneBeforeBed })),\n    systemDetectedIssues: manualAdvice\n  };\n\n  const prompt = `\n  Role: School Health Nurse AI.\n  Target Audience: High School Student.\n  Task: Write a friendly, encouraging, but serious weekly health summary based on the provided data JSON.\n  \n  Data Provided: ${JSON.stringify(dataSummary)}\n\n  Requirements:\n  1. Summarize their performance in Diet, Exercise, and Sleep.\n  2. Specifically reference the \"systemDetectedIssues\" if any exist.\n  3. Give 1 concrete, actionable goal for next week.\n  4. Keep it under 200 words.\n  5. Use Traditional Chinese (zh-TW).\n  `;\n\n  try {\n    const response = await ai.models.generateContent({\n      model: modelId,\n      contents: prompt,\n      config: {\n        maxOutputTokens: 500,\n        temperature: 0.7,\n      },\n    });\n\n    return response.text || \"無法生成報告，請稍後再試。\";\n  } catch (error) {\n    console.error(\"Gemini Report Generation Error:\", error);\n    return \"生成報告時發生錯誤。\";\n  }\n};\n"
            }
          ]
        },
        {
          "path": "components/AnalysisCharts.tsx",
          "generationType": 0,
          "isDone": true,
          "description": "Recharts components for visualization",
          "diffs": [
            {
              "target": "",
              "replacement": "import React from 'react';\nimport {\n  LineChart,\n  Line,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip,\n  Legend,\n  ResponsiveContainer,\n  PieChart,\n  Pie,\n  Cell,\n  BarChart,\n  Bar\n} from 'recharts';\nimport { DietData, ExerciseData, SleepData } from '../types';\n\ninterface ChartProps {\n  dietData: DietData[];\n  exerciseData: ExerciseData[];\n  sleepData: SleepData[];\n}\n\nconst COLORS = ['#10B981', '#3B82F6', '#F59E0B', '#EF4444'];\n\nexport const StepsChart: React.FC<{ data: ExerciseData[] }> = ({ data }) => {\n  // Take last 7 entries\n  const chartData = data.slice(-7).map(d => ({\n    name: d.date.substring(5), // MM-DD\n    steps: d.dailySteps\n  }));\n\n  return (\n    <div className=\"bg-white p-4 rounded-xl shadow-sm border border-gray-100 h-64\">\n      <h3 className=\"text-gray-700 font-bold mb-4 flex items-center\">\n        <i className=\"fa-solid fa-person-walking text-primary mr-2\"></i> 每日步數趨勢\n      </h3>\n      <ResponsiveContainer width=\"100%\" height=\"80%\">\n        <LineChart data={chartData}>\n          <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#f0f0f0\" />\n          <XAxis dataKey=\"name\" fontSize={12} stroke=\"#9CA3AF\" />\n          <YAxis fontSize={12} stroke=\"#9CA3AF\" />\n          <Tooltip \n            contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)' }}\n          />\n          <Line type=\"monotone\" dataKey=\"steps\" stroke=\"#10B981\" strokeWidth={3} activeDot={{ r: 6 }} name=\"步數\" />\n        </LineChart>\n      </ResponsiveContainer>\n    </div>\n  );\n};\n\nexport const NutritionPieChart: React.FC<{ data: DietData[] }> = ({ data }) => {\n  // Calculate average ratios\n  const total = data.length || 1;\n  const avgVeg = data.reduce((acc, curr) => acc + curr.vegRatio, 0) / total;\n  const avgProtein = data.reduce((acc, curr) => acc + curr.proteinRatio, 0) / total;\n  const avgStarch = data.reduce((acc, curr) => acc + curr.starchRatio, 0) / total;\n  \n  // Normalize slightly if they don't add to 1 for the chart\n  const sum = avgVeg + avgProtein + avgStarch || 1;\n  \n  const chartData = [\n    { name: '蔬菜', value: avgVeg / sum },\n    { name: '蛋白質', value: avgProtein / sum },\n    { name: '澱粉', value: avgStarch / sum },\n  ];\n\n  return (\n    <div className=\"bg-white p-4 rounded-xl shadow-sm border border-gray-100 h-64\">\n      <h3 className=\"text-gray-700 font-bold mb-2 flex items-center\">\n        <i className=\"fa-solid fa-carrot text-accent mr-2\"></i> 平均營養比例\n      </h3>\n      <ResponsiveContainer width=\"100%\" height=\"85%\">\n        <PieChart>\n          <Pie\n            data={chartData}\n            cx=\"50%\"\n            cy=\"50%\"\n            innerRadius={60}\n            outerRadius={80}\n            fill=\"#8884d8\"\n            paddingAngle={5}\n            dataKey=\"value\"\n          >\n            {chartData.map((entry, index) => (\n              <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />\n            ))}\n          </Pie>\n          <Tooltip />\n          <Legend verticalAlign=\"bottom\" height={36}/>\n        </PieChart>\n      </ResponsiveContainer>\n    </div>\n  );\n};\n\nexport const SleepBarChart: React.FC<{ data: SleepData[] }> = ({ data }) => {\n    const chartData = data.slice(-7).map(d => ({\n        name: d.date.substring(5),\n        hours: d.sleepDuration\n    }));\n\n    return (\n        <div className=\"bg-white p-4 rounded-xl shadow-sm border border-gray-100 h-64\">\n             <h3 className=\"text-gray-700 font-bold mb-4 flex items-center\">\n                <i className=\"fa-solid fa-bed text-secondary mr-2\"></i> 睡眠時數\n            </h3>\n            <ResponsiveContainer width=\"100%\" height=\"80%\">\n                <BarChart data={chartData}>\n                    <CartesianGrid strokeDasharray=\"3 3\" vertical={false} stroke=\"#f0f0f0\" />\n                    <XAxis dataKey=\"name\" fontSize={12} stroke=\"#9CA3AF\" />\n                    <YAxis fontSize={12} stroke=\"#9CA3AF\" />\n                    <Tooltip cursor={{fill: '#F3F4F6'}} contentStyle={{ borderRadius: '8px' }}/>\n                    <Bar dataKey=\"hours\" fill=\"#3B82F6\" radius={[4, 4, 0, 0]} name=\"小時\" />\n                </BarChart>\n            </ResponsiveContainer>\n        </div>\n    )\n}\n"
            }
          ]
        },
        {
          "path": "App.tsx",
          "generationType": 0,
          "isDone": true,
          "description": "Main application logic, state management, and view routing",
          "diffs": [
            {
              "target": "",
              "replacement": "import React, { useState, useEffect, useMemo, useRef } from 'react';\nimport { DietData, ExerciseData, SleepData, AdviceItem, WeeklyReport } from './types';\nimport { analyzeFoodImage, generateWeeklyReportAI } from './services/geminiService';\nimport { StepsChart, NutritionPieChart, SleepBarChart } from './components/AnalysisCharts';\n\n// --- Helper: Generate Mock Data ---\nconst generateMockData = () => {\n  const dates = Array.from({ length: 7 }, (_, i) => {\n    const d = new Date();\n    d.setDate(d.getDate() - (6 - i));\n    return d.toISOString().split('T')[0];\n  });\n\n  const diets: DietData[] = dates.map(date => ({\n    id: Math.random().toString(),\n    date,\n    calorieIntake: Math.floor(Math.random() * 600 + 400),\n    vegRatio: Math.random() * 0.4 + 0.1, // 0.1 - 0.5\n    proteinRatio: Math.random() * 0.3 + 0.1,\n    starchRatio: Math.random() * 0.4 + 0.2,\n    sugaryDrinksCount: Math.random() > 0.7 ? 1 : 0,\n    friedFoodCount: Math.random() > 0.8 ? 1 : 0,\n  }));\n\n  const exercises: ExerciseData[] = dates.map(date => ({\n    id: Math.random().toString(),\n    date,\n    dailySteps: Math.floor(Math.random() * 5000 + 4000), // 4000 - 9000\n    moderateExerciseMinutes: Math.floor(Math.random() * 40),\n    totalSittingMinutes: Math.floor(Math.random() * 100 + 300),\n  }));\n\n  const sleeps: SleepData[] = dates.map(date => ({\n    id: Math.random().toString(),\n    date,\n    bedTime: \"23:45\",\n    wakeTime: \"06:30\",\n    sleepDuration: 6.5 + Math.random(),\n    usedPhoneBeforeBed: Math.random() > 0.5,\n  }));\n\n  return { diets, exercises, sleeps };\n};\n\n// --- Core Analysis Logic Functions ---\n\nconst analyzeDiet = (weeklyData: DietData[]): AdviceItem[] => {\n  const advice: AdviceItem[] = [];\n  if (weeklyData.length === 0) return advice;\n\n  // 1. Veg & Protein Ratio Check (Average of last 7 entries)\n  const avgVeg = weeklyData.reduce((sum, d) => sum + d.vegRatio, 0) / weeklyData.length;\n  const avgProtein = weeklyData.reduce((sum, d) => sum + d.proteinRatio, 0) / weeklyData.length;\n\n  if (avgVeg < 0.5 || avgProtein < 0.25) {\n    advice.push({\n      category: 'Diet',\n      title: '營養比例失衡',\n      description: '建議採用「健康餐盤法」：1/2 蔬菜、1/4 蛋白質、1/4 澱粉。',\n      priority: 'High'\n    });\n  }\n\n  // 2. Sugary Drinks Check\n  const totalSugary = weeklyData.reduce((sum, d) => sum + d.sugaryDrinksCount, 0);\n  const avgSugary = totalSugary / weeklyData.length;\n  // Threshold: > (7-3)/7 per day => > 0.57\n  if (avgSugary > 0.57) {\n    advice.push({\n      category: 'Diet',\n      title: '含糖飲料攝取過多',\n      description: '提醒每週至少 3 天不喝含糖飲料，多喝水。',\n      priority: 'Medium'\n    });\n  }\n\n  return advice;\n};\n\nconst analyzeExercise = (weeklyData: ExerciseData[]): AdviceItem[] => {\n  const advice: AdviceItem[] = [];\n  if (weeklyData.length === 0) return advice;\n\n  // 1. Steps Check\n  const avgSteps = weeklyData.reduce((sum, d) => sum + d.dailySteps, 0) / weeklyData.length;\n  if (avgSteps < 8000) {\n    advice.push({\n      category: 'Exercise',\n      title: '活動量不足',\n      description: `目前平均步數 ${Math.round(avgSteps)} 步。建議每日目標：8,000–10,000 步。`,\n      priority: 'Medium'\n    });\n  }\n\n  // 2. Moderate Exercise Check (Weekly sum)\n  const totalModMin = weeklyData.reduce((sum, d) => sum + d.moderateExerciseMinutes, 0);\n  if (totalModMin < 180) { // 3 * 60\n    advice.push({\n      category: 'Exercise',\n      title: '中等強度運動不足',\n      description: '每週建議至少 3 次，共 180 分鐘的中等強度運動。',\n      priority: 'High'\n    });\n  }\n\n  // 3. Sitting Check (Simplified for daily avg)\n  const avgSitting = weeklyData.reduce((sum, d) => sum + d.totalSittingMinutes, 0) / weeklyData.length;\n  if (avgSitting > 480) { // > 8 hours\n    advice.push({\n      category: 'Exercise',\n      title: '久坐時間過長',\n      description: '建議每久坐 50 分鐘後，起身活動 5 分鐘。',\n      priority: 'Low'\n    });\n  }\n\n  return advice;\n};\n\nconst analyzeSleep = (weeklyData: SleepData[]): AdviceItem[] => {\n  const advice: AdviceItem[] = [];\n  if (weeklyData.length === 0) return advice;\n\n  // 1. Late Night Check\n  const lateNights = weeklyData.filter(d => {\n    const [hour] = d.bedTime.split(':').map(Number);\n    // If hour is 0, 1, 2, 3 (past midnight) OR hour >= 23 and min > 30... simplified check\n    return (hour >= 0 && hour < 5) || (hour === 23 && parseInt(d.bedTime.split(':')[1]) > 30);\n  }).length;\n\n  if (lateNights > 2) {\n    advice.push({\n      category: 'Sleep',\n      title: '頻繁熬夜',\n      description: '檢測到入睡時間較晚，建議養成規律作息，目標 23:00 前就寢。',\n      priority: 'High'\n    });\n  }\n\n  // 2. Duration Check\n  const avgSleep = weeklyData.reduce((sum, d) => sum + d.sleepDuration, 0) / weeklyData.length;\n  if (avgSleep < 7.5) {\n    advice.push({\n      category: 'Sleep',\n      title: '睡眠時數不足',\n      description: `平均睡眠僅 ${avgSleep.toFixed(1)} 小時。高中生建議每晚睡足 7.5 - 8.5 小時。`,\n      priority: 'High'\n    });\n  }\n\n  // 3. Phone Habits\n  const phoneDays = weeklyData.filter(d => d.usedPhoneBeforeBed).length;\n  if (phoneDays > 3) {\n    advice.push({\n      category: 'Sleep',\n      title: '睡前使用手機',\n      description: '藍光會影響褪黑激素分泌，建議睡前 30 分鐘不要使用手機。',\n      priority: 'Medium'\n    });\n  }\n\n  return advice;\n};\n\n// --- Main App Component ---\n\nenum Tab {\n  DASHBOARD = 'DASHBOARD',\n  DIET = 'DIET',\n  EXERCISE = 'EXERCISE',\n  SLEEP = 'SLEEP',\n  REPORT = 'REPORT'\n}\n\nexport default function App() {\n  const [activeTab, setActiveTab] = useState<Tab>(Tab.DASHBOARD);\n  \n  // Data State\n  const [dietData, setDietData] = useState<DietData[]>([]);\n  const [exerciseData, setExerciseData] = useState<ExerciseData[]>([]);\n  const [sleepData, setSleepData] = useState<SleepData[]>([]);\n  \n  // Report State\n  const [adviceList, setAdviceList] = useState<AdviceItem[]>([]);\n  const [aiReportSummary, setAiReportSummary] = useState<string>('');\n  const [isGeneratingReport, setIsGeneratingReport] = useState(false);\n\n  // Initialize with some mock data on first load for demo purposes\n  useEffect(() => {\n    const { diets, exercises, sleeps } = generateMockData();\n    setDietData(diets);\n    setExerciseData(exercises);\n    setSleepData(sleeps);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  // Recalculate advice whenever data changes\n  useEffect(() => {\n    const dietAdvice = analyzeDiet(dietData);\n    const exerciseAdvice = analyzeExercise(exerciseData);\n    const sleepAdvice = analyzeSleep(sleepData);\n    setAdviceList([...dietAdvice, ...exerciseAdvice, ...sleepAdvice]);\n  }, [dietData, exerciseData, sleepData]);\n\n  // --- Input Handlers ---\n\n  const handleDietSubmit = (data: DietData) => {\n    setDietData(prev => [...prev, data]);\n    setActiveTab(Tab.DASHBOARD);\n  };\n\n  const handleExerciseSubmit = (data: ExerciseData) => {\n    setExerciseData(prev => [...prev, data]);\n    setActiveTab(Tab.DASHBOARD);\n  };\n\n  const handleSleepSubmit = (data: SleepData) => {\n    setSleepData(prev => [...prev, data]);\n    setActiveTab(Tab.DASHBOARD);\n  };\n\n  const handleGenerateReport = async () => {\n    setIsGeneratingReport(true);\n    try {\n      const summary = await generateWeeklyReportAI(dietData, exerciseData, sleepData, adviceList);\n      setAiReportSummary(summary);\n    } catch (e) {\n      setAiReportSummary(\"報告生成失敗，請檢查網路連線。\");\n    } finally {\n      setIsGeneratingReport(false);\n    }\n  };\n\n  // --- Render Views ---\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 text-gray-800 pb-20 font-sans\">\n      {/* Header */}\n      <header className=\"bg-white shadow-sm sticky top-0 z-20\">\n        <div className=\"max-w-md mx-auto px-4 py-4 flex justify-between items-center\">\n          <h1 className=\"text-xl font-bold text-primary flex items-center\">\n            <i className=\"fa-solid fa-heart-pulse mr-2\"></i>\n            AI 智慧健康管理\n          </h1>\n          <button \n            onClick={() => {\n               const { diets, exercises, sleeps } = generateMockData();\n               setDietData(diets); setExerciseData(exercises); setSleepData(sleeps);\n            }}\n            className=\"text-xs text-gray-400 hover:text-primary\"\n          >\n            重置數據\n          </button>\n        </div>\n      </header>\n\n      {/* Main Content Area */}\n      <main className=\"max-w-md mx-auto p-4 space-y-6\">\n        \n        {activeTab === Tab.DASHBOARD && (\n          <DashboardView \n            dietData={dietData} \n            exerciseData={exerciseData} \n            sleepData={sleepData} \n            adviceCount={adviceList.length}\n            onNavigate={setActiveTab}\n          />\n        )}\n\n        {activeTab === Tab.DIET && <DietInputView onSave={handleDietSubmit} onCancel={() => setActiveTab(Tab.DASHBOARD)} />}\n        {activeTab === Tab.EXERCISE && <ExerciseInputView onSave={handleExerciseSubmit} onCancel={() => setActiveTab(Tab.DASHBOARD)} />}\n        {activeTab === Tab.SLEEP && <SleepInputView onSave={handleSleepSubmit} onCancel={() => setActiveTab(Tab.DASHBOARD)} />}\n        \n        {activeTab === Tab.REPORT && (\n          <ReportView \n            adviceList={adviceList} \n            summary={aiReportSummary} \n            isGenerating={isGeneratingReport} \n            onGenerate={handleGenerateReport}\n          />\n        )}\n\n      </main>\n\n      {/* Bottom Navigation */}\n      <nav className=\"fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-10\">\n        <div className=\"max-w-md mx-auto flex justify-around py-3\">\n          <NavButton icon=\"fa-house\" label=\"首頁\" active={activeTab === Tab.DASHBOARD} onClick={() => setActiveTab(Tab.DASHBOARD)} />\n          <NavButton icon=\"fa-carrot\" label=\"飲食\" active={activeTab === Tab.DIET} onClick={() => setActiveTab(Tab.DIET)} />\n          <NavButton icon=\"fa-person-running\" label=\"運動\" active={activeTab === Tab.EXERCISE} onClick={() => setActiveTab(Tab.EXERCISE)} />\n          <NavButton icon=\"fa-bed\" label=\"睡眠\" active={activeTab === Tab.SLEEP} onClick={() => setActiveTab(Tab.SLEEP)} />\n          <NavButton icon=\"fa-file-medical\" label=\"週報\" active={activeTab === Tab.REPORT} onClick={() => setActiveTab(Tab.REPORT)} />\n        </div>\n      </nav>\n    </div>\n  );\n}\n\n// --- Sub-Components ---\n\nconst NavButton = ({ icon, label, active, onClick }: { icon: string, label: string, active: boolean, onClick: () => void }) => (\n  <button onClick={onClick} className={`flex flex-col items-center w-full ${active ? 'text-primary' : 'text-gray-400'}`}>\n    <i className={`fa-solid ${icon} text-lg mb-1`}></i>\n    <span className=\"text-xs font-medium\">{label}</span>\n  </button>\n);\n\nconst DashboardView: React.FC<any> = ({ dietData, exerciseData, sleepData, adviceCount, onNavigate }) => {\n  return (\n    <div className=\"space-y-6 animate-fade-in\">\n      {/* Status Cards */}\n      <div className=\"grid grid-cols-2 gap-4\">\n        <div className=\"bg-gradient-to-br from-emerald-400 to-emerald-600 text-white p-4 rounded-xl shadow-lg\"\n             onClick={() => onNavigate(Tab.REPORT)}>\n          <div className=\"flex justify-between items-start\">\n            <span className=\"text-sm font-medium opacity-90\">待處理建議</span>\n            <i className=\"fa-solid fa-bell opacity-80\"></i>\n          </div>\n          <div className=\"mt-2 text-3xl font-bold\">{adviceCount}</div>\n          <div className=\"text-xs opacity-75 mt-1\">點擊查看建議</div>\n        </div>\n        <div className=\"bg-white p-4 rounded-xl shadow-md border border-gray-100 flex flex-col justify-center items-center text-center\">\n             <span className=\"text-gray-500 text-sm mb-1\">今日紀錄</span>\n             <span className=\"text-primary font-bold text-lg\">\n                {(new Date()).toISOString().split('T')[0].slice(5)}\n             </span>\n             <span className=\"text-xs text-gray-400 mt-1\">保持健康好習慣！</span>\n        </div>\n      </div>\n\n      {/* Charts */}\n      <div className=\"space-y-4\">\n        <StepsChart data={exerciseData} />\n        <NutritionPieChart data={dietData} />\n        <SleepBarChart data={sleepData} />\n      </div>\n    </div>\n  );\n};\n\n// --- Input Views ---\n\nconst DietInputView: React.FC<{ onSave: (d: DietData) => void, onCancel: () => void }> = ({ onSave, onCancel }) => {\n  const [analyzing, setAnalyzing] = useState(false);\n  const [imagePreview, setImagePreview] = useState<string | null>(null);\n  const [formData, setFormData] = useState<Partial<DietData>>({\n    date: new Date().toISOString().split('T')[0],\n    sugaryDrinksCount: 0,\n    friedFoodCount: 0\n  });\n\n  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (!file) return;\n\n    // Preview\n    const reader = new FileReader();\n    reader.onloadend = async () => {\n      const base64 = reader.result as string;\n      setImagePreview(base64);\n      \n      // Analyze with Gemini\n      setAnalyzing(true);\n      try {\n        const base64Data = base64.split(',')[1]; // Remove data:image/jpeg;base64,\n        const result = await analyzeFoodImage(base64Data);\n        setFormData(prev => ({\n          ...prev,\n          ...result\n        }));\n      } catch (error) {\n        alert(\"分析失敗，請手動輸入數據\");\n      } finally {\n        setAnalyzing(false);\n      }\n    };\n    reader.readAsDataURL(file);\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (formData.calorieIntake !== undefined) {\n      onSave({\n        id: Math.random().toString(),\n        date: formData.date!,\n        calorieIntake: formData.calorieIntake!,\n        vegRatio: formData.vegRatio || 0,\n        proteinRatio: formData.proteinRatio || 0,\n        starchRatio: formData.starchRatio || 0,\n        sugaryDrinksCount: formData.sugaryDrinksCount || 0,\n        friedFoodCount: formData.friedFoodCount || 0\n      });\n    } else {\n        alert(\"請輸入完整的飲食資訊或上傳照片\");\n    }\n  };\n\n  return (\n    <div className=\"bg-white p-6 rounded-xl shadow-md space-y-4 animate-fade-in-up\">\n      <h2 className=\"text-xl font-bold text-gray-800\">新增飲食紀錄</h2>\n      \n      <div className=\"space-y-2\">\n        <label className=\"block text-sm font-medium text-gray-700\">拍照/上傳食物 (Gemini AI 分析)</label>\n        <div className=\"relative\">\n          <input type=\"file\" accept=\"image/*\" onChange={handleFileChange} className=\"hidden\" id=\"food-upload\" />\n          <label htmlFor=\"food-upload\" className=\"flex flex-col items-center justify-center w-full h-40 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 bg-gray-50 overflow-hidden\">\n            {imagePreview ? (\n              <img src={imagePreview} alt=\"Preview\" className=\"w-full h-full object-cover\" />\n            ) : (\n              <>\n                <i className=\"fa-solid fa-camera text-2xl text-gray-400 mb-2\"></i>\n                <span className=\"text-sm text-gray-500\">點擊上傳</span>\n              </>\n            )}\n          </label>\n        </div>\n      </div>\n\n      {analyzing && (\n        <div className=\"flex items-center text-primary space-x-2\">\n            <i className=\"fa-solid fa-circle-notch fa-spin\"></i>\n            <span>AI 正在分析營養成分...</span>\n        </div>\n      )}\n\n      <form onSubmit={handleSubmit} className=\"space-y-4\">\n        <div>\n           <label className=\"text-xs text-gray-500\">日期</label>\n           <input type=\"date\" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} className=\"w-full border rounded p-2\" />\n        </div>\n        \n        <div className=\"grid grid-cols-2 gap-4\">\n            <div>\n                <label className=\"text-xs text-gray-500\">熱量 (kcal)</label>\n                <input type=\"number\" value={formData.calorieIntake || ''} onChange={e => setFormData({...formData, calorieIntake: Number(e.target.value)})} className=\"w-full border rounded p-2\" placeholder=\"0\" />\n            </div>\n            <div>\n                 <label className=\"text-xs text-gray-500\">含糖飲料(次)</label>\n                 <input type=\"number\" value={formData.sugaryDrinksCount} onChange={e => setFormData({...formData, sugaryDrinksCount: Number(e.target.value)})} className=\"w-full border rounded p-2\" />\n            </div>\n        </div>\n\n        <div>\n             <label className=\"text-xs text-gray-500 block mb-1\">餐盤比例 (0-1)</label>\n             <div className=\"flex space-x-2\">\n                <input type=\"number\" step=\"0.1\" max=\"1\" placeholder=\"菜\" value={formData.vegRatio || ''} onChange={e => setFormData({...formData, vegRatio: Number(e.target.value)})} className=\"w-full border rounded p-2 bg-green-50\" />\n                <input type=\"number\" step=\"0.1\" max=\"1\" placeholder=\"肉\" value={formData.proteinRatio || ''} onChange={e => setFormData({...formData, proteinRatio: Number(e.target.value)})} className=\"w-full border rounded p-2 bg-red-50\" />\n                <input type=\"number\" step=\"0.1\" max=\"1\" placeholder=\"飯\" value={formData.starchRatio || ''} onChange={e => setFormData({...formData, starchRatio: Number(e.target.value)})} className=\"w-full border rounded p-2 bg-yellow-50\" />\n             </div>\n        </div>\n\n        <div className=\"flex space-x-3 pt-2\">\n             <button type=\"button\" onClick={onCancel} className=\"flex-1 py-2 rounded-lg border border-gray-300 text-gray-600\">取消</button>\n             <button type=\"submit\" className=\"flex-1 py-2 rounded-lg bg-primary text-white font-bold shadow-md hover:bg-emerald-600\">儲存</button>\n        </div>\n      </form>\n    </div>\n  );\n};\n\nconst ExerciseInputView: React.FC<{ onSave: (d: ExerciseData) => void, onCancel: () => void }> = ({ onSave, onCancel }) => {\n    const [data, setData] = useState<Partial<ExerciseData>>({\n        date: new Date().toISOString().split('T')[0],\n        dailySteps: 0,\n        moderateExerciseMinutes: 0,\n        totalSittingMinutes: 0\n    });\n\n    return (\n        <div className=\"bg-white p-6 rounded-xl shadow-md space-y-4 animate-fade-in-up\">\n             <h2 className=\"text-xl font-bold text-gray-800\">新增運動紀錄</h2>\n             <div className=\"space-y-4\">\n                 <div>\n                    <label className=\"text-xs text-gray-500\">日期</label>\n                    <input type=\"date\" value={data.date} onChange={e => setData({...data, date: e.target.value})} className=\"w-full border rounded p-2\" />\n                 </div>\n                 <div>\n                    <label className=\"text-xs text-gray-500\">今日步數</label>\n                    <input type=\"number\" value={data.dailySteps || ''} onChange={e => setData({...data, dailySteps: Number(e.target.value)})} className=\"w-full border rounded p-2\" placeholder=\"ex: 8000\" />\n                 </div>\n                 <div>\n                    <label className=\"text-xs text-gray-500\">中等強度運動 (分鐘)</label>\n                    <input type=\"number\" value={data.moderateExerciseMinutes || ''} onChange={e => setData({...data, moderateExerciseMinutes: Number(e.target.value)})} className=\"w-full border rounded p-2\" placeholder=\"ex: 30\" />\n                 </div>\n                 <div>\n                    <label className=\"text-xs text-gray-500\">久坐時間 (分鐘)</label>\n                    <input type=\"number\" value={data.totalSittingMinutes || ''} onChange={e => setData({...data, totalSittingMinutes: Number(e.target.value)})} className=\"w-full border rounded p-2\" placeholder=\"ex: 480\" />\n                 </div>\n                 <div className=\"flex space-x-3 pt-2\">\n                    <button onClick={onCancel} className=\"flex-1 py-2 rounded-lg border border-gray-300 text-gray-600\">取消</button>\n                    <button onClick={() => onSave({id: Math.random().toString(), ...data} as ExerciseData)} className=\"flex-1 py-2 rounded-lg bg-secondary text-white font-bold shadow-md hover:bg-blue-600\">儲存</button>\n                </div>\n             </div>\n        </div>\n    )\n}\n\nconst SleepInputView: React.FC<{ onSave: (d: SleepData) => void, onCancel: () => void }> = ({ onSave, onCancel }) => {\n    const [data, setData] = useState<Partial<SleepData>>({\n        date: new Date().toISOString().split('T')[0],\n        bedTime: '23:00',\n        wakeTime: '07:00',\n        usedPhoneBeforeBed: false\n    });\n\n    const calculateDuration = () => {\n        const start = new Date(`2000-01-01T${data.bedTime}`);\n        const end = new Date(`2000-01-01T${data.wakeTime}`);\n        if (end < start) end.setDate(end.getDate() + 1);\n        const diff = (end.getTime() - start.getTime()) / 1000 / 60 / 60;\n        return diff;\n    }\n\n    return (\n        <div className=\"bg-white p-6 rounded-xl shadow-md space-y-4 animate-fade-in-up\">\n             <h2 className=\"text-xl font-bold text-gray-800\">新增睡眠紀錄</h2>\n             <div className=\"space-y-4\">\n                 <div>\n                    <label className=\"text-xs text-gray-500\">日期</label>\n                    <input type=\"date\" value={data.date} onChange={e => setData({...data, date: e.target.value})} className=\"w-full border rounded p-2\" />\n                 </div>\n                 <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                        <label className=\"text-xs text-gray-500\">入睡時間</label>\n                        <input type=\"time\" value={data.bedTime} onChange={e => setData({...data, bedTime: e.target.value})} className=\"w-full border rounded p-2\" />\n                    </div>\n                    <div>\n                        <label className=\"text-xs text-gray-500\">起床時間</label>\n                        <input type=\"time\" value={data.wakeTime} onChange={e => setData({...data, wakeTime: e.target.value})} className=\"w-full border rounded p-2\" />\n                    </div>\n                 </div>\n                 \n                 <div className=\"flex items-center space-x-2 py-2\">\n                    <input type=\"checkbox\" id=\"phone\" checked={data.usedPhoneBeforeBed} onChange={e => setData({...data, usedPhoneBeforeBed: e.target.checked})} className=\"w-5 h-5 text-primary rounded\" />\n                    <label htmlFor=\"phone\" className=\"text-gray-700\">睡前 30 分鐘使用手機</label>\n                 </div>\n\n                 <div className=\"flex space-x-3 pt-2\">\n                    <button onClick={onCancel} className=\"flex-1 py-2 rounded-lg border border-gray-300 text-gray-600\">取消</button>\n                    <button onClick={() => onSave({id: Math.random().toString(), sleepDuration: calculateDuration(), ...data} as SleepData)} className=\"flex-1 py-2 rounded-lg bg-accent text-white font-bold shadow-md hover:bg-amber-600\">儲存</button>\n                </div>\n             </div>\n        </div>\n    )\n}\n\nconst ReportView: React.FC<{ adviceList: AdviceItem[], summary: string, isGenerating: boolean, onGenerate: () => void }> = ({ adviceList, summary, isGenerating, onGenerate }) => {\n    return (\n        <div className=\"space-y-6 animate-fade-in pb-12\">\n            \n            {/* AI Report Card */}\n            <div className=\"bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-6 rounded-xl shadow-lg\">\n                <div className=\"flex justify-between items-center mb-4\">\n                     <h2 className=\"text-xl font-bold\"><i className=\"fa-solid fa-robot mr-2\"></i>AI 健康週報</h2>\n                     {!summary && !isGenerating && (\n                         <button onClick={onGenerate} className=\"bg-white text-indigo-600 px-4 py-1.5 rounded-full text-sm font-bold shadow hover:bg-gray-100 transition\">\n                             生成分析\n                         </button>\n                     )}\n                </div>\n                \n                {isGenerating ? (\n                    <div className=\"py-8 text-center\">\n                        <i className=\"fa-solid fa-spinner fa-spin text-3xl mb-2\"></i>\n                        <p>AI 正在分析您的健康數據...</p>\n                    </div>\n                ) : summary ? (\n                    <div className=\"bg-white/10 p-4 rounded-lg text-sm leading-relaxed backdrop-blur-sm\">\n                        {summary.split('\\n').map((line, i) => <p key={i} className=\"mb-2\">{line}</p>)}\n                    </div>\n                ) : (\n                    <p className=\"opacity-80 text-sm\">點擊生成按鈕，讓 AI 為您分析本週的健康狀況並提供建議。</p>\n                )}\n            </div>\n\n            {/* Advice Table */}\n            <div className=\"bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden\">\n                <div className=\"p-4 border-b border-gray-100 bg-gray-50\">\n                    <h3 className=\"font-bold text-gray-700\">系統建議摘要</h3>\n                </div>\n                {adviceList.length === 0 ? (\n                    <div className=\"p-8 text-center text-gray-400\">\n                        <i className=\"fa-regular fa-thumbs-up text-3xl mb-2\"></i>\n                        <p>太棒了！目前沒有發現顯著的健康問題。</p>\n                    </div>\n                ) : (\n                    <div className=\"divide-y divide-gray-100\">\n                        {adviceList.map((advice, idx) => (\n                            <div key={idx} className=\"p-4 flex items-start space-x-3\">\n                                <div className={`mt-1 w-2 h-2 rounded-full flex-shrink-0 \n                                    ${advice.priority === 'High' ? 'bg-red-500' : advice.priority === 'Medium' ? 'bg-yellow-500' : 'bg-green-500'}`} \n                                />\n                                <div>\n                                    <div className=\"flex items-center space-x-2\">\n                                        <span className=\"text-xs font-bold text-gray-400 uppercase tracking-wider\">{advice.category}</span>\n                                        <h4 className=\"font-bold text-gray-800\">{advice.title}</h4>\n                                    </div>\n                                    <p className=\"text-sm text-gray-600 mt-1\">{advice.description}</p>\n                                </div>\n                            </div>\n                        ))}\n                    </div>\n                )}\n            </div>\n        </div>\n    );\n};\n"
            }
          ]
        }
      ]
    },
    "createdTimestamp": 1765619304575,
    "doneTimestamp": 1765619304757
  },
  {
    "id": 3,
    "author": "user",
    "payload": {
      "type": "text",
      "text": "Add gamification elements to the AI health management system. This includes a point system for achieving daily/weekly goals, badges for milestones (e.g., '1 Week Perfect Sleep Streak'), and weekly challenges related to diet or exercise.",
      "files": [],
      "fileUploads": [],
      "cMarkNode": {}
    },
    "createdTimestamp": 1765619425694
  },
  {
    "id": 4,
    "author": "model",
    "payload": {
      "type": "thinking",
      "text": "**Implementing Gamification Ideas**\n\nI'm currently fleshing out the gamification aspects for the AI health system. The core revolves around a point system tied to daily/weekly goals like step counts, diet adherence, and sleep quality. I'm exploring different badge designs and levels, as well as a competitive leaderboard, to add a layer of engagement and motivation.\n\n\n**Developing Gamification Elements**\n\nI've made progress on the data structures, adding UserPoints, the Badge interface, and a Challenge interface. I'm also working on initializing the points, badges, and challenges states within App.tsx and implementing the logic for calculating points and unlocking badges.  I'm exploring the design of the UI components, focusing on the new Gamification Dashboard section, specifically how to display earned badges, active challenges, and overall progress.\n\n\n**Adding UI Components**\n\nI'm now focusing on integrating the gamification elements into the dashboard. Specifically, I'm designing UI components to display the user's current points and level, earned badges, and active challenges, along with their progress. I also want to include feedback to the user on how points and badges are being earned.\n\n\n**Streamlining Gamification Implementation**\n\nI've revised the implementation plan to prioritize simplicity. The focus is on clean separation, so I'll create `GamificationService` to handle the heavy lifting. I am adding the `Badge`, `Challenge`, and `UserProfile` interfaces to `types.ts`. I also plan to update various event handlers like `handleDietSubmit`, `handleExerciseSubmit`, and `handleSleepSubmit` in `App.tsx` so they invoke functions from `GamificationService` to recalculate points, check for badge unlocks, and update state.\n\n\n**Enhancing App Integration**\n\nI'm currently working to integrate gamification into `App.tsx` and the dashboard. I've imported necessary types and services, introduced new state for points and earned badges, and set up an effect hook to recalculate these values based on data changes. I'm also adding a display for points and level in the header and a new \"My Progress\" section to the dashboard, which will visually represent user points, earned badges (grayscale for locked, colored for unlocked), and active challenges. I'm focusing on progress bars for points and challenges, and an icon grid for badges to provide a clear and engaging user experience.\n\n\n**Finalizing Integration Details**\n\nI'm now in the process of finalizing the integration. I've defined `calculatePoints`, `checkBadges`, and `getChallenges` within `gamificationService`. I've also established mock data for badges and challenges, including titles and descriptions. I'm focusing on integrating the `GamificationService` into `App.tsx`, adding the gamification section to the dashboard, and displaying level and points in the header. The plan is to have a `useEffect` within `App` that triggers `calculateGamificationStats` whenever the diet, exercise, or sleep data changes, updating the relevant gamification state. This approach ensures a seamless and responsive gamification experience.\n\n\n**Defining Weekly Challenges**\n\nOkay, weekly challenges are in progress. I'm adding weekly goals to the data, and using the existing mock data from the past week as the \"current week\" to evaluate these challenges. The gamification logic is being expanded with weekly challenges, including calculating points, checking for badge unlocks, and updating the state accordingly.\n\n\n**Updating Dashboard Integration**\n\nI'm now focusing on integrating the gamification elements, now including Challenges & Badges, directly into the Dashboard. I'm modifying `DashboardView` to display total points, active challenge progress, and recent badges. I'll add a section for this, avoiding a new dedicated tab, for an integrated experience as requested. I've updated the plan to use a `GamificationUtils.ts` file with pure functions for point calculation, badge unlocking, and challenge progress, keeping logic cleaner. I'm working on the design of the \"Challenges & Badges\" section within the `DashboardView`.\n\n\n**Optimizing Dashboard Display**\n\nI'm now integrating the gamification state with the dashboard view. I've added a section to display total points, progress on active challenges, and recent badges. I am designing a consolidated experience. I'm focused on a \"See All\" button for badges. I'm also readying the `calculateGamificationState` and adding the `GamificationSummary` component.\n\n\n**Evaluating Recent Progress**\n\nI'm now integrating the point calculation logic into the system, and working on badges. I'm starting to define the point system with the base system, including diet, exercise, and sleep. I'm also including badges such as the \"步數達人\" and \"黃金睡眠\" badges.\n\n\n**Evaluating Complex Logic**\n\nI'm now integrating the point system with the dashboard view. I'm focusing on \"健康飲食\" badges, adding the streak logic for sleep badges, and planning to add weekly challenges. Now, I'm working to expand the point calculation logic and implement weekly challenges. The goal is to provide a compelling user experience with clearly displayed badges and challenges.\n\n\n**Integrating State Updates**\n\nI'm now focusing on integrating the gamification logic, including challenges and badges, with the application state.  I'll be updating `App.tsx` and the dashboard to reflect these changes.  I've defined functions in `gamificationLogic.ts` for calculations and badge management. The new design includes a card for points/level, progress bars for challenges, and circular icons for badges in the dashboard. I'm leveraging Tailwind for styling.\n\n\n**Creating New Gamification File**\n\nI'm now starting a new service file for all gamification logic, including challenges and badges, which I will then integrate with the application state in `App.tsx` and the dashboard view. The goal is a clean and maintainable architecture for the gamification system. The design calls for a dedicated card to display points and level, progress bars for challenges, and circular icons for badges. Tailwind will be used for styling.\n\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": 1765619425694,
    "doneTimestamp": 1765619506121
  },
  {
    "id": 5,
    "author": "model",
    "payload": {
      "type": "text",
      "text": "Based on your request to add gamification elements (points, badges, weekly challenges), I will make the following changes:\n\n1.  **Update `types.ts`**: Add interfaces for `Badge`, `Challenge`, and `GamificationState` to support the new features.\n2.  **Create `services/gamificationLogic.ts`**: Implement the logic to calculate points based on health data, check badge unlocking conditions (e.g., streaks, thresholds), and track weekly challenge progress.\n3.  **Update `App.tsx`**:\n    *   Integrate the gamification logic to update state whenever diet, exercise, or sleep data changes.\n    *   Update the `DashboardView` to display a new \"My Achievements\" section, including a level progress bar, earned badges, and active weekly challenges.\n\nHere are the changes:\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": 1765619506121,
    "doneTimestamp": 1765619506121
  },
  {
    "id": 6,
    "author": "model",
    "payload": {
      "type": "generationTable",
      "entries": [
        {
          "path": "types.ts",
          "generationType": 1,
          "isDone": true,
          "description": "Add Gamification interfaces",
          "diffs": [
            {
              "target": "",
              "replacement": "export interface DietData {\n  id: string;\n  date: string; // YYYY-MM-DD\n  calorieIntake: number;\n  vegRatio: number; // 0.0 - 1.0\n  proteinRatio: number; // 0.0 - 1.0\n  starchRatio: number; // 0.0 - 1.0\n  sugaryDrinksCount: number;\n  friedFoodCount: number;\n  imageUrl?: string;\n}\n\nexport interface ExerciseData {\n  id: string;\n  date: string; // YYYY-MM-DD\n  dailySteps: number;\n  moderateExerciseMinutes: number;\n  totalSittingMinutes: number;\n}\n\nexport interface SleepData {\n  id: string;\n  date: string; // YYYY-MM-DD\n  bedTime: string; // HH:mm\n  wakeTime: string; // HH:mm\n  sleepDuration: number; // Hours (float)\n  usedPhoneBeforeBed: boolean;\n}\n\nexport interface AdviceItem {\n  category: 'Diet' | 'Exercise' | 'Sleep';\n  title: string;\n  description: string;\n  priority: 'High' | 'Medium' | 'Low';\n}\n\nexport interface WeeklyReport {\n  generatedAt: string;\n  summary: string;\n  adviceList: AdviceItem[];\n}\n\n// --- Gamification Types ---\n\nexport interface Badge {\n  id: string;\n  name: string;\n  description: string;\n  icon: string; // Font Awesome class suffix (e.g., 'trophy')\n  color: string; // Tailwind color class (e.g., 'text-yellow-400')\n  isUnlocked: boolean;\n  unlockedDate?: string;\n}\n\nexport interface Challenge {\n  id: string;\n  title: string;\n  description: string;\n  target: number;\n  current: number;\n  unit: string;\n  isCompleted: boolean;\n  type: 'Diet' | 'Exercise' | 'Sleep';\n}\n\nexport interface GamificationState {\n  totalPoints: number;\n  level: number;\n  progressToNextLevel: number; // 0 - 100\n  badges: Badge[];\n  challenges: Challenge[];\n}\n"
            }
          ]
        },
        {
          "path": "services/gamificationLogic.ts",
          "generationType": 1,
          "isDone": true,
          "description": "Logic for points, badges, and challenges",
          "diffs": [
            {
              "target": "",
              "replacement": "import { DietData, ExerciseData, SleepData, Badge, Challenge, GamificationState } from '../types';\n\nexport const calculateGamificationState = (\n  diets: DietData[],\n  exercises: ExerciseData[],\n  sleeps: SleepData[]\n): GamificationState => {\n  let points = 0;\n\n  // --- 1. Point Calculation System ---\n  // Diet Points\n  diets.forEach(d => {\n    // Balanced Meal: Veg >= 30%, Protein >= 20%\n    if (d.vegRatio >= 0.3 && d.proteinRatio >= 0.2) points += 20;\n    // Healthy Choice: No sugary drinks\n    if (d.sugaryDrinksCount === 0) points += 10;\n    // Healthy Choice: No fried food\n    if (d.friedFoodCount === 0) points += 10;\n  });\n\n  // Exercise Points\n  exercises.forEach(e => {\n    // Step Goal\n    if (e.dailySteps >= 8000) points += 15;\n    // Extra Push\n    if (e.dailySteps >= 12000) points += 10;\n    // Moderate Exercise\n    if (e.moderateExerciseMinutes >= 30) points += 20;\n  });\n\n  // Sleep Points\n  sleeps.forEach(s => {\n    // Good Sleep Duration\n    if (s.sleepDuration >= 7.0 && s.sleepDuration <= 9.0) points += 20;\n    // Good Habits\n    if (!s.usedPhoneBeforeBed) points += 15;\n  });\n\n  // Level System: Every 200 points is a level\n  const pointsPerLevel = 200;\n  const level = Math.floor(points / pointsPerLevel) + 1;\n  const progressToNextLevel = Math.floor(((points % pointsPerLevel) / pointsPerLevel) * 100);\n\n  // --- 2. Badges Logic ---\n  const badges: Badge[] = [\n    {\n      id: 'first_step',\n      name: '初出茅廬',\n      description: '紀錄第一筆運動數據',\n      icon: 'fa-person-walking',\n      color: 'text-blue-400',\n      isUnlocked: exercises.length > 0\n    },\n    {\n      id: 'step_master',\n      name: '萬步天王',\n      description: '單日步數超過 10,000 步',\n      icon: 'fa-fire',\n      color: 'text-red-500',\n      isUnlocked: exercises.some(e => e.dailySteps >= 10000)\n    },\n    {\n      id: 'sleep_streak',\n      name: '好眠大師',\n      description: '連續 3 天睡眠達標 (7+ 小時)',\n      icon: 'fa-moon',\n      color: 'text-purple-400',\n      isUnlocked: false // Calculated below\n    },\n    {\n      id: 'clean_eater',\n      name: '飲食清流',\n      description: '累積 3 天不喝含糖飲料',\n      icon: 'fa-leaf',\n      color: 'text-green-500',\n      isUnlocked: diets.filter(d => d.sugaryDrinksCount === 0).length >= 3\n    }\n  ];\n\n  // Logic for Sleep Streak\n  let sleepStreak = 0;\n  let maxSleepStreak = 0;\n  const sortedSleeps = [...sleeps].sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());\n  \n  sortedSleeps.forEach(s => {\n      if (s.sleepDuration >= 7) {\n          sleepStreak++;\n          maxSleepStreak = Math.max(maxSleepStreak, sleepStreak);\n      } else {\n          sleepStreak = 0;\n      }\n  });\n  if (maxSleepStreak >= 3) {\n      const badge = badges.find(b => b.id === 'sleep_streak');\n      if (badge) badge.isUnlocked = true;\n  }\n\n  // --- 3. Weekly Challenges Logic ---\n  // We assume the data passed in is roughly for the \"current week\" for simplicity\n  const totalSteps = exercises.reduce((acc, curr) => acc + curr.dailySteps, 0);\n  const totalModMins = exercises.reduce((acc, curr) => acc + curr.moderateExerciseMinutes, 0);\n  const balancedMeals = diets.filter(d => d.vegRatio >= 0.3 && d.proteinRatio >= 0.2).length;\n\n  const challenges: Challenge[] = [\n    {\n      id: 'weekly_steps',\n      title: '本週步數挑戰',\n      description: '累積 50,000 步',\n      target: 50000,\n      current: totalSteps,\n      unit: '步',\n      isCompleted: totalSteps >= 50000,\n      type: 'Exercise'\n    },\n    {\n      id: 'active_week',\n      title: '熱血燃燒',\n      description: '累積 150 分鐘中等強度運動',\n      target: 150,\n      current: totalModMins,\n      unit: '分鐘',\n      isCompleted: totalModMins >= 150,\n      type: 'Exercise'\n    },\n    {\n      id: 'balanced_diet',\n      title: '營養滿分',\n      description: '攝取 5 餐均衡飲食',\n      target: 5,\n      current: balancedMeals,\n      unit: '餐',\n      isCompleted: balancedMeals >= 5,\n      type: 'Diet'\n    }\n  ];\n\n  return {\n    totalPoints: points,\n    level,\n    progressToNextLevel,\n    badges,\n    challenges\n  };\n};\n"
            }
          ]
        },
        {
          "path": "App.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Integrate Gamification Dashboard",
          "diffs": [
            {
              "target": "",
              "replacement": "import React, { useState, useEffect, useMemo, useRef } from 'react';\nimport { DietData, ExerciseData, SleepData, AdviceItem, WeeklyReport, GamificationState } from './types';\nimport { analyzeFoodImage, generateWeeklyReportAI } from './services/geminiService';\nimport { calculateGamificationState } from './services/gamificationLogic';\nimport { StepsChart, NutritionPieChart, SleepBarChart } from './components/AnalysisCharts';\n\n// --- Helper: Generate Mock Data ---\nconst generateMockData = () => {\n  const dates = Array.from({ length: 7 }, (_, i) => {\n    const d = new Date();\n    d.setDate(d.getDate() - (6 - i));\n    return d.toISOString().split('T')[0];\n  });\n\n  const diets: DietData[] = dates.map(date => ({\n    id: Math.random().toString(),\n    date,\n    calorieIntake: Math.floor(Math.random() * 600 + 400),\n    vegRatio: Math.random() * 0.4 + 0.1, // 0.1 - 0.5\n    proteinRatio: Math.random() * 0.3 + 0.1,\n    starchRatio: Math.random() * 0.4 + 0.2,\n    sugaryDrinksCount: Math.random() > 0.7 ? 1 : 0,\n    friedFoodCount: Math.random() > 0.8 ? 1 : 0,\n  }));\n\n  const exercises: ExerciseData[] = dates.map(date => ({\n    id: Math.random().toString(),\n    date,\n    dailySteps: Math.floor(Math.random() * 5000 + 4000), // 4000 - 9000\n    moderateExerciseMinutes: Math.floor(Math.random() * 40),\n    totalSittingMinutes: Math.floor(Math.random() * 100 + 300),\n  }));\n\n  const sleeps: SleepData[] = dates.map(date => ({\n    id: Math.random().toString(),\n    date,\n    bedTime: \"23:45\",\n    wakeTime: \"06:30\",\n    sleepDuration: 6.5 + Math.random(),\n    usedPhoneBeforeBed: Math.random() > 0.5,\n  }));\n\n  return { diets, exercises, sleeps };\n};\n\n// --- Core Analysis Logic Functions ---\n\nconst analyzeDiet = (weeklyData: DietData[]): AdviceItem[] => {\n  const advice: AdviceItem[] = [];\n  if (weeklyData.length === 0) return advice;\n\n  // 1. Veg & Protein Ratio Check (Average of last 7 entries)\n  const avgVeg = weeklyData.reduce((sum, d) => sum + d.vegRatio, 0) / weeklyData.length;\n  const avgProtein = weeklyData.reduce((sum, d) => sum + d.proteinRatio, 0) / weeklyData.length;\n\n  if (avgVeg < 0.5 || avgProtein < 0.25) {\n    advice.push({\n      category: 'Diet',\n      title: '營養比例失衡',\n      description: '建議採用「健康餐盤法」：1/2 蔬菜、1/4 蛋白質、1/4 澱粉。',\n      priority: 'High'\n    });\n  }\n\n  // 2. Sugary Drinks Check\n  const totalSugary = weeklyData.reduce((sum, d) => sum + d.sugaryDrinksCount, 0);\n  const avgSugary = totalSugary / weeklyData.length;\n  // Threshold: > (7-3)/7 per day => > 0.57\n  if (avgSugary > 0.57) {\n    advice.push({\n      category: 'Diet',\n      title: '含糖飲料攝取過多',\n      description: '提醒每週至少 3 天不喝含糖飲料，多喝水。',\n      priority: 'Medium'\n    });\n  }\n\n  return advice;\n};\n\nconst analyzeExercise = (weeklyData: ExerciseData[]): AdviceItem[] => {\n  const advice: AdviceItem[] = [];\n  if (weeklyData.length === 0) return advice;\n\n  // 1. Steps Check\n  const avgSteps = weeklyData.reduce((sum, d) => sum + d.dailySteps, 0) / weeklyData.length;\n  if (avgSteps < 8000) {\n    advice.push({\n      category: 'Exercise',\n      title: '活動量不足',\n      description: `目前平均步數 ${Math.round(avgSteps)} 步。建議每日目標：8,000–10,000 步。`,\n      priority: 'Medium'\n    });\n  }\n\n  // 2. Moderate Exercise Check (Weekly sum)\n  const totalModMin = weeklyData.reduce((sum, d) => sum + d.moderateExerciseMinutes, 0);\n  if (totalModMin < 180) { // 3 * 60\n    advice.push({\n      category: 'Exercise',\n      title: '中等強度運動不足',\n      description: '每週建議至少 3 次，共 180 分鐘的中等強度運動。',\n      priority: 'High'\n    });\n  }\n\n  // 3. Sitting Check (Simplified for daily avg)\n  const avgSitting = weeklyData.reduce((sum, d) => sum + d.totalSittingMinutes, 0) / weeklyData.length;\n  if (avgSitting > 480) { // > 8 hours\n    advice.push({\n      category: 'Exercise',\n      title: '久坐時間過長',\n      description: '建議每久坐 50 分鐘後，起身活動 5 分鐘。',\n      priority: 'Low'\n    });\n  }\n\n  return advice;\n};\n\nconst analyzeSleep = (weeklyData: SleepData[]): AdviceItem[] => {\n  const advice: AdviceItem[] = [];\n  if (weeklyData.length === 0) return advice;\n\n  // 1. Late Night Check\n  const lateNights = weeklyData.filter(d => {\n    const [hour] = d.bedTime.split(':').map(Number);\n    // If hour is 0, 1, 2, 3 (past midnight) OR hour >= 23 and min > 30... simplified check\n    return (hour >= 0 && hour < 5) || (hour === 23 && parseInt(d.bedTime.split(':')[1]) > 30);\n  }).length;\n\n  if (lateNights > 2) {\n    advice.push({\n      category: 'Sleep',\n      title: '頻繁熬夜',\n      description: '檢測到入睡時間較晚，建議養成規律作息，目標 23:00 前就寢。',\n      priority: 'High'\n    });\n  }\n\n  // 2. Duration Check\n  const avgSleep = weeklyData.reduce((sum, d) => sum + d.sleepDuration, 0) / weeklyData.length;\n  if (avgSleep < 7.5) {\n    advice.push({\n      category: 'Sleep',\n      title: '睡眠時數不足',\n      description: `平均睡眠僅 ${avgSleep.toFixed(1)} 小時。高中生建議每晚睡足 7.5 - 8.5 小時。`,\n      priority: 'High'\n    });\n  }\n\n  // 3. Phone Habits\n  const phoneDays = weeklyData.filter(d => d.usedPhoneBeforeBed).length;\n  if (phoneDays > 3) {\n    advice.push({\n      category: 'Sleep',\n      title: '睡前使用手機',\n      description: '藍光會影響褪黑激素分泌，建議睡前 30 分鐘不要使用手機。',\n      priority: 'Medium'\n    });\n  }\n\n  return advice;\n};\n\n// --- Main App Component ---\n\nenum Tab {\n  DASHBOARD = 'DASHBOARD',\n  DIET = 'DIET',\n  EXERCISE = 'EXERCISE',\n  SLEEP = 'SLEEP',\n  REPORT = 'REPORT'\n}\n\nexport default function App() {\n  const [activeTab, setActiveTab] = useState<Tab>(Tab.DASHBOARD);\n  \n  // Data State\n  const [dietData, setDietData] = useState<DietData[]>([]);\n  const [exerciseData, setExerciseData] = useState<ExerciseData[]>([]);\n  const [sleepData, setSleepData] = useState<SleepData[]>([]);\n  \n  // Report State\n  const [adviceList, setAdviceList] = useState<AdviceItem[]>([]);\n  const [aiReportSummary, setAiReportSummary] = useState<string>('');\n  const [isGeneratingReport, setIsGeneratingReport] = useState(false);\n\n  // Gamification State\n  const [gameState, setGameState] = useState<GamificationState>({\n      totalPoints: 0,\n      level: 1,\n      progressToNextLevel: 0,\n      badges: [],\n      challenges: []\n  });\n\n  // Initialize with some mock data on first load for demo purposes\n  useEffect(() => {\n    const { diets, exercises, sleeps } = generateMockData();\n    setDietData(diets);\n    setExerciseData(exercises);\n    setSleepData(sleeps);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  // Recalculate advice AND Gamification whenever data changes\n  useEffect(() => {\n    const dietAdvice = analyzeDiet(dietData);\n    const exerciseAdvice = analyzeExercise(exerciseData);\n    const sleepAdvice = analyzeSleep(sleepData);\n    setAdviceList([...dietAdvice, ...exerciseAdvice, ...sleepAdvice]);\n\n    // Update Gamification\n    const newGameState = calculateGamificationState(dietData, exerciseData, sleepData);\n    setGameState(newGameState);\n\n  }, [dietData, exerciseData, sleepData]);\n\n  // --- Input Handlers ---\n\n  const handleDietSubmit = (data: DietData) => {\n    setDietData(prev => [...prev, data]);\n    setActiveTab(Tab.DASHBOARD);\n  };\n\n  const handleExerciseSubmit = (data: ExerciseData) => {\n    setExerciseData(prev => [...prev, data]);\n    setActiveTab(Tab.DASHBOARD);\n  };\n\n  const handleSleepSubmit = (data: SleepData) => {\n    setSleepData(prev => [...prev, data]);\n    setActiveTab(Tab.DASHBOARD);\n  };\n\n  const handleGenerateReport = async () => {\n    setIsGeneratingReport(true);\n    try {\n      const summary = await generateWeeklyReportAI(dietData, exerciseData, sleepData, adviceList);\n      setAiReportSummary(summary);\n    } catch (e) {\n      setAiReportSummary(\"報告生成失敗，請檢查網路連線。\");\n    } finally {\n      setIsGeneratingReport(false);\n    }\n  };\n\n  // --- Render Views ---\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 text-gray-800 pb-20 font-sans\">\n      {/* Header */}\n      <header className=\"bg-white shadow-sm sticky top-0 z-20\">\n        <div className=\"max-w-md mx-auto px-4 py-4 flex justify-between items-center\">\n          <h1 className=\"text-xl font-bold text-primary flex items-center\">\n            <i className=\"fa-solid fa-heart-pulse mr-2\"></i>\n            AI 智慧健康管理\n          </h1>\n          <button \n            onClick={() => {\n               const { diets, exercises, sleeps } = generateMockData();\n               setDietData(diets); setExerciseData(exercises); setSleepData(sleeps);\n            }}\n            className=\"text-xs text-gray-400 hover:text-primary\"\n          >\n            重置數據\n          </button>\n        </div>\n      </header>\n\n      {/* Main Content Area */}\n      <main className=\"max-w-md mx-auto p-4 space-y-6\">\n        \n        {activeTab === Tab.DASHBOARD && (\n          <DashboardView \n            dietData={dietData} \n            exerciseData={exerciseData} \n            sleepData={sleepData} \n            adviceCount={adviceList.length}\n            gameState={gameState}\n            onNavigate={setActiveTab}\n          />\n        )}\n\n        {activeTab === Tab.DIET && <DietInputView onSave={handleDietSubmit} onCancel={() => setActiveTab(Tab.DASHBOARD)} />}\n        {activeTab === Tab.EXERCISE && <ExerciseInputView onSave={handleExerciseSubmit} onCancel={() => setActiveTab(Tab.DASHBOARD)} />}\n        {activeTab === Tab.SLEEP && <SleepInputView onSave={handleSleepSubmit} onCancel={() => setActiveTab(Tab.DASHBOARD)} />}\n        \n        {activeTab === Tab.REPORT && (\n          <ReportView \n            adviceList={adviceList} \n            summary={aiReportSummary} \n            isGenerating={isGeneratingReport} \n            onGenerate={handleGenerateReport}\n          />\n        )}\n\n      </main>\n\n      {/* Bottom Navigation */}\n      <nav className=\"fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-10\">\n        <div className=\"max-w-md mx-auto flex justify-around py-3\">\n          <NavButton icon=\"fa-house\" label=\"首頁\" active={activeTab === Tab.DASHBOARD} onClick={() => setActiveTab(Tab.DASHBOARD)} />\n          <NavButton icon=\"fa-carrot\" label=\"飲食\" active={activeTab === Tab.DIET} onClick={() => setActiveTab(Tab.DIET)} />\n          <NavButton icon=\"fa-person-running\" label=\"運動\" active={activeTab === Tab.EXERCISE} onClick={() => setActiveTab(Tab.EXERCISE)} />\n          <NavButton icon=\"fa-bed\" label=\"睡眠\" active={activeTab === Tab.SLEEP} onClick={() => setActiveTab(Tab.SLEEP)} />\n          <NavButton icon=\"fa-file-medical\" label=\"週報\" active={activeTab === Tab.REPORT} onClick={() => setActiveTab(Tab.REPORT)} />\n        </div>\n      </nav>\n    </div>\n  );\n}\n\n// --- Sub-Components ---\n\nconst NavButton = ({ icon, label, active, onClick }: { icon: string, label: string, active: boolean, onClick: () => void }) => (\n  <button onClick={onClick} className={`flex flex-col items-center w-full ${active ? 'text-primary' : 'text-gray-400'}`}>\n    <i className={`fa-solid ${icon} text-lg mb-1`}></i>\n    <span className=\"text-xs font-medium\">{label}</span>\n  </button>\n);\n\nconst DashboardView: React.FC<any> = ({ dietData, exerciseData, sleepData, adviceCount, gameState, onNavigate }) => {\n  return (\n    <div className=\"space-y-6 animate-fade-in\">\n      \n      {/* --- Gamification Section --- */}\n      <div className=\"bg-white rounded-xl shadow-sm border border-gray-100 p-4\">\n          <div className=\"flex justify-between items-end mb-2\">\n              <div>\n                  <h2 className=\"text-lg font-bold text-gray-800\">等級 {gameState.level}</h2>\n                  <span className=\"text-xs text-gray-500\">總積分: {gameState.totalPoints}</span>\n              </div>\n              <span className=\"text-xs font-bold text-primary\">{gameState.progressToNextLevel}%</span>\n          </div>\n          {/* Progress Bar */}\n          <div className=\"w-full bg-gray-100 rounded-full h-2.5 mb-4\">\n              <div className=\"bg-primary h-2.5 rounded-full transition-all duration-500\" style={{ width: `${gameState.progressToNextLevel}%` }}></div>\n          </div>\n          \n          {/* Badges Preview */}\n          <div className=\"flex space-x-3 overflow-x-auto no-scrollbar pb-2\">\n              {gameState.badges.map((badge: any) => (\n                  <div key={badge.id} className={`flex-shrink-0 flex flex-col items-center justify-center w-16 h-16 rounded-lg border ${badge.isUnlocked ? 'border-amber-200 bg-amber-50' : 'border-gray-100 bg-gray-50 opacity-50'}`}>\n                      <i className={`fa-solid ${badge.icon} text-xl mb-1 ${badge.isUnlocked ? badge.color : 'text-gray-300'}`}></i>\n                      <span className=\"text-[10px] text-gray-600 truncate w-14 text-center\">{badge.name}</span>\n                  </div>\n              ))}\n          </div>\n      </div>\n\n      {/* --- Active Challenges --- */}\n      <div className=\"space-y-3\">\n          <h3 className=\"font-bold text-gray-700 flex items-center\">\n              <i className=\"fa-solid fa-trophy text-accent mr-2\"></i> 本週挑戰\n          </h3>\n          {gameState.challenges.map((challenge: any) => (\n              <div key={challenge.id} className=\"bg-white p-3 rounded-lg border border-gray-100 shadow-sm flex items-center space-x-3\">\n                  <div className={`w-10 h-10 rounded-full flex items-center justify-center ${challenge.isCompleted ? 'bg-green-100 text-green-600' : 'bg-blue-50 text-blue-500'}`}>\n                      <i className={`fa-solid ${challenge.type === 'Diet' ? 'fa-carrot' : challenge.type === 'Exercise' ? 'fa-person-running' : 'fa-bed'}`}></i>\n                  </div>\n                  <div className=\"flex-1\">\n                      <div className=\"flex justify-between\">\n                          <h4 className=\"text-sm font-bold text-gray-800\">{challenge.title}</h4>\n                          <span className=\"text-xs text-gray-500\">{challenge.current} / {challenge.target} {challenge.unit}</span>\n                      </div>\n                      <div className=\"w-full bg-gray-100 rounded-full h-1.5 mt-1\">\n                          <div className={`h-1.5 rounded-full ${challenge.isCompleted ? 'bg-green-500' : 'bg-blue-500'}`} \n                               style={{ width: `${Math.min(100, (challenge.current / challenge.target) * 100)}%` }}></div>\n                      </div>\n                  </div>\n              </div>\n          ))}\n      </div>\n\n      {/* Status Cards */}\n      <div className=\"grid grid-cols-2 gap-4\">\n        <div className=\"bg-gradient-to-br from-emerald-400 to-emerald-600 text-white p-4 rounded-xl shadow-lg\"\n             onClick={() => onNavigate(Tab.REPORT)}>\n          <div className=\"flex justify-between items-start\">\n            <span className=\"text-sm font-medium opacity-90\">待處理建議</span>\n            <i className=\"fa-solid fa-bell opacity-80\"></i>\n          </div>\n          <div className=\"mt-2 text-3xl font-bold\">{adviceCount}</div>\n          <div className=\"text-xs opacity-75 mt-1\">點擊查看建議</div>\n        </div>\n        <div className=\"bg-white p-4 rounded-xl shadow-md border border-gray-100 flex flex-col justify-center items-center text-center\">\n             <span className=\"text-gray-500 text-sm mb-1\">今日紀錄</span>\n             <span className=\"text-primary font-bold text-lg\">\n                {(new Date()).toISOString().split('T')[0].slice(5)}\n             </span>\n             <span className=\"text-xs text-gray-400 mt-1\">保持健康好習慣！</span>\n        </div>\n      </div>\n\n      {/* Charts */}\n      <div className=\"space-y-4\">\n        <StepsChart data={exerciseData} />\n        <NutritionPieChart data={dietData} />\n        <SleepBarChart data={sleepData} />\n      </div>\n    </div>\n  );\n};\n\n// --- Input Views ---\n\nconst DietInputView: React.FC<{ onSave: (d: DietData) => void, onCancel: () => void }> = ({ onSave, onCancel }) => {\n  const [analyzing, setAnalyzing] = useState(false);\n  const [imagePreview, setImagePreview] = useState<string | null>(null);\n  const [formData, setFormData] = useState<Partial<DietData>>({\n    date: new Date().toISOString().split('T')[0],\n    sugaryDrinksCount: 0,\n    friedFoodCount: 0\n  });\n\n  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (!file) return;\n\n    // Preview\n    const reader = new FileReader();\n    reader.onloadend = async () => {\n      const base64 = reader.result as string;\n      setImagePreview(base64);\n      \n      // Analyze with Gemini\n      setAnalyzing(true);\n      try {\n        const base64Data = base64.split(',')[1]; // Remove data:image/jpeg;base64,\n        const result = await analyzeFoodImage(base64Data);\n        setFormData(prev => ({\n          ...prev,\n          ...result\n        }));\n      } catch (error) {\n        alert(\"分析失敗，請手動輸入數據\");\n      } finally {\n        setAnalyzing(false);\n      }\n    };\n    reader.readAsDataURL(file);\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (formData.calorieIntake !== undefined) {\n      onSave({\n        id: Math.random().toString(),\n        date: formData.date!,\n        calorieIntake: formData.calorieIntake!,\n        vegRatio: formData.vegRatio || 0,\n        proteinRatio: formData.proteinRatio || 0,\n        starchRatio: formData.starchRatio || 0,\n        sugaryDrinksCount: formData.sugaryDrinksCount || 0,\n        friedFoodCount: formData.friedFoodCount || 0\n      });\n    } else {\n        alert(\"請輸入完整的飲食資訊或上傳照片\");\n    }\n  };\n\n  return (\n    <div className=\"bg-white p-6 rounded-xl shadow-md space-y-4 animate-fade-in-up\">\n      <h2 className=\"text-xl font-bold text-gray-800\">新增飲食紀錄</h2>\n      \n      <div className=\"space-y-2\">\n        <label className=\"block text-sm font-medium text-gray-700\">拍照/上傳食物 (Gemini AI 分析)</label>\n        <div className=\"relative\">\n          <input type=\"file\" accept=\"image/*\" onChange={handleFileChange} className=\"hidden\" id=\"food-upload\" />\n          <label htmlFor=\"food-upload\" className=\"flex flex-col items-center justify-center w-full h-40 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 bg-gray-50 overflow-hidden\">\n            {imagePreview ? (\n              <img src={imagePreview} alt=\"Preview\" className=\"w-full h-full object-cover\" />\n            ) : (\n              <>\n                <i className=\"fa-solid fa-camera text-2xl text-gray-400 mb-2\"></i>\n                <span className=\"text-sm text-gray-500\">點擊上傳</span>\n              </>\n            )}\n          </label>\n        </div>\n      </div>\n\n      {analyzing && (\n        <div className=\"flex items-center text-primary space-x-2\">\n            <i className=\"fa-solid fa-circle-notch fa-spin\"></i>\n            <span>AI 正在分析營養成分...</span>\n        </div>\n      )}\n\n      <form onSubmit={handleSubmit} className=\"space-y-4\">\n        <div>\n           <label className=\"text-xs text-gray-500\">日期</label>\n           <input type=\"date\" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} className=\"w-full border rounded p-2\" />\n        </div>\n        \n        <div className=\"grid grid-cols-2 gap-4\">\n            <div>\n                <label className=\"text-xs text-gray-500\">熱量 (kcal)</label>\n                <input type=\"number\" value={formData.calorieIntake || ''} onChange={e => setFormData({...formData, calorieIntake: Number(e.target.value)})} className=\"w-full border rounded p-2\" placeholder=\"0\" />\n            </div>\n            <div>\n                 <label className=\"text-xs text-gray-500\">含糖飲料(次)</label>\n                 <input type=\"number\" value={formData.sugaryDrinksCount} onChange={e => setFormData({...formData, sugaryDrinksCount: Number(e.target.value)})} className=\"w-full border rounded p-2\" />\n            </div>\n        </div>\n\n        <div>\n             <label className=\"text-xs text-gray-500 block mb-1\">餐盤比例 (0-1)</label>\n             <div className=\"flex space-x-2\">\n                <input type=\"number\" step=\"0.1\" max=\"1\" placeholder=\"菜\" value={formData.vegRatio || ''} onChange={e => setFormData({...formData, vegRatio: Number(e.target.value)})} className=\"w-full border rounded p-2 bg-green-50\" />\n                <input type=\"number\" step=\"0.1\" max=\"1\" placeholder=\"肉\" value={formData.proteinRatio || ''} onChange={e => setFormData({...formData, proteinRatio: Number(e.target.value)})} className=\"w-full border rounded p-2 bg-red-50\" />\n                <input type=\"number\" step=\"0.1\" max=\"1\" placeholder=\"飯\" value={formData.starchRatio || ''} onChange={e => setFormData({...formData, starchRatio: Number(e.target.value)})} className=\"w-full border rounded p-2 bg-yellow-50\" />\n             </div>\n        </div>\n\n        <div className=\"flex space-x-3 pt-2\">\n             <button type=\"button\" onClick={onCancel} className=\"flex-1 py-2 rounded-lg border border-gray-300 text-gray-600\">取消</button>\n             <button type=\"submit\" className=\"flex-1 py-2 rounded-lg bg-primary text-white font-bold shadow-md hover:bg-emerald-600\">儲存</button>\n        </div>\n      </form>\n    </div>\n  );\n};\n\nconst ExerciseInputView: React.FC<{ onSave: (d: ExerciseData) => void, onCancel: () => void }> = ({ onSave, onCancel }) => {\n    const [data, setData] = useState<Partial<ExerciseData>>({\n        date: new Date().toISOString().split('T')[0],\n        dailySteps: 0,\n        moderateExerciseMinutes: 0,\n        totalSittingMinutes: 0\n    });\n\n    return (\n        <div className=\"bg-white p-6 rounded-xl shadow-md space-y-4 animate-fade-in-up\">\n             <h2 className=\"text-xl font-bold text-gray-800\">新增運動紀錄</h2>\n             <div className=\"space-y-4\">\n                 <div>\n                    <label className=\"text-xs text-gray-500\">日期</label>\n                    <input type=\"date\" value={data.date} onChange={e => setData({...data, date: e.target.value})} className=\"w-full border rounded p-2\" />\n                 </div>\n                 <div>\n                    <label className=\"text-xs text-gray-500\">今日步數</label>\n                    <input type=\"number\" value={data.dailySteps || ''} onChange={e => setData({...data, dailySteps: Number(e.target.value)})} className=\"w-full border rounded p-2\" placeholder=\"ex: 8000\" />\n                 </div>\n                 <div>\n                    <label className=\"text-xs text-gray-500\">中等強度運動 (分鐘)</label>\n                    <input type=\"number\" value={data.moderateExerciseMinutes || ''} onChange={e => setData({...data, moderateExerciseMinutes: Number(e.target.value)})} className=\"w-full border rounded p-2\" placeholder=\"ex: 30\" />\n                 </div>\n                 <div>\n                    <label className=\"text-xs text-gray-500\">久坐時間 (分鐘)</label>\n                    <input type=\"number\" value={data.totalSittingMinutes || ''} onChange={e => setData({...data, totalSittingMinutes: Number(e.target.value)})} className=\"w-full border rounded p-2\" placeholder=\"ex: 480\" />\n                 </div>\n                 <div className=\"flex space-x-3 pt-2\">\n                    <button onClick={onCancel} className=\"flex-1 py-2 rounded-lg border border-gray-300 text-gray-600\">取消</button>\n                    <button onClick={() => onSave({id: Math.random().toString(), ...data} as ExerciseData)} className=\"flex-1 py-2 rounded-lg bg-secondary text-white font-bold shadow-md hover:bg-blue-600\">儲存</button>\n                </div>\n             </div>\n        </div>\n    )\n}\n\nconst SleepInputView: React.FC<{ onSave: (d: SleepData) => void, onCancel: () => void }> = ({ onSave, onCancel }) => {\n    const [data, setData] = useState<Partial<SleepData>>({\n        date: new Date().toISOString().split('T')[0],\n        bedTime: '23:00',\n        wakeTime: '07:00',\n        usedPhoneBeforeBed: false\n    });\n\n    const calculateDuration = () => {\n        const start = new Date(`2000-01-01T${data.bedTime}`);\n        const end = new Date(`2000-01-01T${data.wakeTime}`);\n        if (end < start) end.setDate(end.getDate() + 1);\n        const diff = (end.getTime() - start.getTime()) / 1000 / 60 / 60;\n        return diff;\n    }\n\n    return (\n        <div className=\"bg-white p-6 rounded-xl shadow-md space-y-4 animate-fade-in-up\">\n             <h2 className=\"text-xl font-bold text-gray-800\">新增睡眠紀錄</h2>\n             <div className=\"space-y-4\">\n                 <div>\n                    <label className=\"text-xs text-gray-500\">日期</label>\n                    <input type=\"date\" value={data.date} onChange={e => setData({...data, date: e.target.value})} className=\"w-full border rounded p-2\" />\n                 </div>\n                 <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                        <label className=\"text-xs text-gray-500\">入睡時間</label>\n                        <input type=\"time\" value={data.bedTime} onChange={e => setData({...data, bedTime: e.target.value})} className=\"w-full border rounded p-2\" />\n                    </div>\n                    <div>\n                        <label className=\"text-xs text-gray-500\">起床時間</label>\n                        <input type=\"time\" value={data.wakeTime} onChange={e => setData({...data, wakeTime: e.target.value})} className=\"w-full border rounded p-2\" />\n                    </div>\n                 </div>\n                 \n                 <div className=\"flex items-center space-x-2 py-2\">\n                    <input type=\"checkbox\" id=\"phone\" checked={data.usedPhoneBeforeBed} onChange={e => setData({...data, usedPhoneBeforeBed: e.target.checked})} className=\"w-5 h-5 text-primary rounded\" />\n                    <label htmlFor=\"phone\" className=\"text-gray-700\">睡前 30 分鐘使用手機</label>\n                 </div>\n\n                 <div className=\"flex space-x-3 pt-2\">\n                    <button onClick={onCancel} className=\"flex-1 py-2 rounded-lg border border-gray-300 text-gray-600\">取消</button>\n                    <button onClick={() => onSave({id: Math.random().toString(), sleepDuration: calculateDuration(), ...data} as SleepData)} className=\"flex-1 py-2 rounded-lg bg-accent text-white font-bold shadow-md hover:bg-amber-600\">儲存</button>\n                </div>\n             </div>\n        </div>\n    )\n}\n\nconst ReportView: React.FC<{ adviceList: AdviceItem[], summary: string, isGenerating: boolean, onGenerate: () => void }> = ({ adviceList, summary, isGenerating, onGenerate }) => {\n    return (\n        <div className=\"space-y-6 animate-fade-in pb-12\">\n            \n            {/* AI Report Card */}\n            <div className=\"bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-6 rounded-xl shadow-lg\">\n                <div className=\"flex justify-between items-center mb-4\">\n                     <h2 className=\"text-xl font-bold\"><i className=\"fa-solid fa-robot mr-2\"></i>AI 健康週報</h2>\n                     {!summary && !isGenerating && (\n                         <button onClick={onGenerate} className=\"bg-white text-indigo-600 px-4 py-1.5 rounded-full text-sm font-bold shadow hover:bg-gray-100 transition\">\n                             生成分析\n                         </button>\n                     )}\n                </div>\n                \n                {isGenerating ? (\n                    <div className=\"py-8 text-center\">\n                        <i className=\"fa-solid fa-spinner fa-spin text-3xl mb-2\"></i>\n                        <p>AI 正在分析您的健康數據...</p>\n                    </div>\n                ) : summary ? (\n                    <div className=\"bg-white/10 p-4 rounded-lg text-sm leading-relaxed backdrop-blur-sm\">\n                        {summary.split('\\n').map((line, i) => <p key={i} className=\"mb-2\">{line}</p>)}\n                    </div>\n                ) : (\n                    <p className=\"opacity-80 text-sm\">點擊生成按鈕，讓 AI 為您分析本週的健康狀況並提供建議。</p>\n                )}\n            </div>\n\n            {/* Advice Table */}\n            <div className=\"bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden\">\n                <div className=\"p-4 border-b border-gray-100 bg-gray-50\">\n                    <h3 className=\"font-bold text-gray-700\">系統建議摘要</h3>\n                </div>\n                {adviceList.length === 0 ? (\n                    <div className=\"p-8 text-center text-gray-400\">\n                        <i className=\"fa-regular fa-thumbs-up text-3xl mb-2\"></i>\n                        <p>太棒了！目前沒有發現顯著的健康問題。</p>\n                    </div>\n                ) : (\n                    <div className=\"divide-y divide-gray-100\">\n                        {adviceList.map((advice, idx) => (\n                            <div key={idx} className=\"p-4 flex items-start space-x-3\">\n                                <div className={`mt-1 w-2 h-2 rounded-full flex-shrink-0 \n                                    ${advice.priority === 'High' ? 'bg-red-500' : advice.priority === 'Medium' ? 'bg-yellow-500' : 'bg-green-500'}`} \n                                />\n                                <div>\n                                    <div className=\"flex items-center space-x-2\">\n                                        <span className=\"text-xs font-bold text-gray-400 uppercase tracking-wider\">{advice.category}</span>\n                                        <h4 className=\"font-bold text-gray-800\">{advice.title}</h4>\n                                    </div>\n                                    <p className=\"text-sm text-gray-600 mt-1\">{advice.description}</p>\n                                </div>\n                            </div>\n                        ))}\n                    </div>\n                )}\n            </div>\n        </div>\n    );\n};\n"
            }
          ]
        }
      ]
    },
    "createdTimestamp": 1765619506951,
    "doneTimestamp": 1765619510960
  },
  {
    "id": 8,
    "author": "user",
    "payload": {
      "type": "text",
      "text": "出現這個",
      "files": [
        "{\"name\":\"螢幕擷取畫面 2025-12-13 212029.png\",\"type\":\"image/png\",\"size\":6551,\"lastModified\":1765632031896,\"data\":\"iVBORw0KGgoAAAANSUhEUgAAAikAAAAcCAYAAACkuy8pAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAFiUAABYlAUlSJPAAABksSURBVHhe7Z0HeJTF1sf/KbvpCWmE3jsYASlyESkWpIQivYoggnygoiggKEoREEWvFAsXVEBBkSZEQVDx6r1eUEHwild6ESRAekjfzTf/yfuGzbK7ye4msOj8HufZzbvD7NmZM2fOnCl6Ne/SowAKhUKhUCgUHsTlc6fhrb1XKBQKhUKh8BiiqtZUTopCoVAoFArPRDkpCoVCoVAoPBLlpCgUCoVCofBI7G+cLRCP83NFyil8NeWLZ2bxgVfh59bYeuztA/gYAF8/kYziva/2gUKhUCgUCoVj7DspZuGUZKUjOEekvCswCGfFy4GT4mXjcb5wULJ9A5BqDEa+XwjgF6h9olAoFAqFQuEY+04KoyepCfibTyY6+ptQGWYYxeMCOimlXCRKKvDC0XxvbMsyIDEgAggK1z5RKBQKhUKhcIx9d4NRk9wsVCzIQ2OjN2JCghEUFAhfPwOM/kaEhoWhYkylohQZFQ2/gAD4GAzwNfgiROSp4eeD+gYz/POzAFOeVrBCUf7MmvIofvh8Kz79YBXat2mlPVUoFIq/Fm1a3Ir491dKezh76mTt6c2DAyeFe1LyEGQ2IczbG1cM/kgKi0JSpZpIiqmBlPAYpAVXQFaFaGSERCAlOBzJUVWRKD67HFkFF32MonRvRHh7wZcOismkFawoTyaMGo59O7dg46rl2pPyhw7BgS+2F0t8diOJbdIIPj4+iIqMwK3ivUKhcI0e93TBt9s2YOeH78kB72bhRssdFBiAOVOfwJ4t67B/97Yi21gWttmZslvdeguioyKlPWzasL72tDisH9aTXg6Tp7S344UbOioogEk4KkmZmTA2vBW1h45HtX5jgOp1kXDpIvKEI5OeloakrBxEdo5DneETUO3+kUg1BiI9VzgnXl6ihOLoymNZIZbpeg6w14NlC2bj6y3rpQOhuD4cOvw/4RebcDkxCQfF+5uBAb26S8Pw0Yql2pM/D7oRtGf4dEf3Rju3NwvKpng+zz4xSYx1nREWEiKGQTsHTlzEmbJ/OPgzLl1OlPbwl9+Oak9vHkreXUInQ9RBfn4+vAMCEVStJqJib0Nk6w7wb9wSf1xMRlZQOMLbdUb0be0QXKsefIJCC0/zeLF4L3hJL8X21pe/ApUqRiEgwF/768/HCy+/jhZ39ZRpy2efa09vLJSp1b290X3oaPxr3w/aU88mOiIC4RXCxIyn5G6p+GvzZ7cpNzt0xFvc0lQ6BvG7vkS/0ROKbCTfu4OzZe87cBA9ho2R9vC5ha9qT4vDPF0HPSDLGDdlBi4Kp8ZTKMEaCseCTpq3FwwFZpjTUpBz+SL8g4MRdWtrRHfoKh0UY/1mqNylB4KqVocpMxOZZ0/BX+Q3+vgUFmMHVgQrRK9gRxWtUCgUCsXNAJdXggID5Ri3bvM2nDh9RvvEfcqzbE/E/ume3CzgwjEMCynAwEh/XDYByd5GmCrVQu2hYxHZJBZG4ayknT0NY0goDCKl/H4G53dsRfJX8QgryEakVwFS8s2Y/0cmzgTFAOFVZNFc7pn+6CO4IhyaZxcsll6cPSaOGYkR/fvAZDZjycrVWLfpE+0TyDW57nd3wqXEJMxZvFTOmBku7nXfPdjwSTyCAgJxZ7s2CAkOgln8+9+OncCrb62S4S9LbmnSCA8PH4yWsc0QKGYnzHv2/B94d/1Gm5GBmOgoTHroAdzRthVCRR2QtIwMfLZ7D5auWi1+VxbeWjQPbVo6Xs+jkln//gcH90f/uG5iphQNb29vZGZl45v/7JNyJ1y6rOUqRJe7xS1NhNwBMuyXl58PX+Ecnjxz1m1n72+tW2L8yKGoX7c2/P38SqwXwvrv0+1e+TmjGbawru+CggKkpqVjx5dfF9WfJYP7xqF/z26oVb2qXFfNzcuTHXPVBxuw6+tvtVyFM4w5055ARdGJdWzVsQ7bqGmjBli68j10an87WjRrAqPRiNzcXOzdfxDzXltWrM65Djxx9Ejc16UjwkKvDbOy7t9d9zGWv7tWe1Iyel9g2Y6wrs8RA/qit9Dz6lUrw2gwyLZJSk7Bjq/+iTffe79YHZaH3M6itw2x1R7WeqPnz7hyBWs2bMGowf1QvUplKTv72oZPPsWyVWu0f12I3i87tG0t+zy5nJQsbcY76z+WfxNupH72iYlST6g/U+cs1D6B7HuPPjQKfkYD1ny8RejG6qI2OnPuvOjjX0l9ZP+kLCx/zUebZF5LPMmmsF6H9uuFOjWqF/Yfod8H/nsYy95Zi5+tlkKt5eBvZBSd/452tiR77YjSto87bV8ecrP/jH9gGLqJ/hMRXkGWnZ2Tg4O//GqzDomuMwmXLpX5pLu0Zet9yhJHdlmnpL6q44xeuUMpIile4j9v+Am75p+ZDvPJIzi+aR0uHvoRvv4BCK/XAAHRFZGdkoyT2zcjZe838E9NRIBJDJaaLSxuEp2DRuK7H3+Sg+Swfr1l5yc0Jh3/1hZ5efn4cGt8sZC+t5D53o4dRGN2RmhIocKyEps0rI/J40YXGxDYIHNFg1C5aUwInYOa1aoKRRgvlHOofKZTp2YNLHnxefS4++p6IBPfx3W9Wwx27bSczvPMYxPwyIPDUaVSjJSBUKaune/E6/NmSZl0aGgXznxayk2vmjIQg69v0Xt3YP0umDlV1jfrnuj1MmJAH/m3K1DuRc9NK1bflLdCWCgG9emJV16YUax9HhwyAI+PfRB1a9WQbUg4KDeqV1c6Lu7CkDkd4bYtm0sHhfC1vZDv/0aPkH/rTJv0CAb27iFlLYs6dhUaqXHCeWSdsC4I24abhAeLOhw3cph8puMpcrtCtcqVhPzjpd7xN1J+9rVBvXvi/h5dtVyQn1Ovut/VqajPM0WLOmH7zprymJYT0lbQZuTm5qFju7ZSxwj79sBePRAcFChtDm2PJTWEQ8iy9P6plz9m+CDZR3U8yaaMGToQUyaMRf3ata72H6Hf1PeXRH1RVh3KQTvDOtTlIL5lYFOcaR+d0rZ9ecpNW0SbxLEnMiK8qDzaRNYhf5N+epBOgb6vku3Pf0vZ9GdMPNTgyj6i8izbFZzRK3dx7KRoMRY2jI+Y7fqJV0NuNhIP7UfqqRMwiRmtl48vCswFyBFOSuKhA8i78DsCfLzgK/LLwr1Fo7IcG/EazmTeenlesYpm4ozBktdXvItjJ0+jSkxFPCI8WjbO4D5xsqE4E3pn3QYt51W4tn/uQgJeWvY27hs8Snjkm6WnV7tmdcTde5eWC8IT7C299NO/n8OcxUvkctPYJ6ZLQ0Ylp/FhJ9F5dOwo1KtdU85sPtm5W3qyLJ8G7ez583LGRMY9NaNo+Yqzfs5WV6xZX/SMiWuAupfK77m3cwdRl2bEi9kay70jboD87YlitlFHyN272z0yLxkkBp3Koj440+dvZF7K8eHW7fK73IGOyajB/eVs57yoQ8rA8odPmIxtn3+BlLR0LafzjBzQV856OLvR5Wa5X/97r4yo3Nq0sTBA92m5gdbNY+HnZ8TX3+2TdcJ6mzj9eXz57XfIzCoecWFdOruuSoeWUSi20ZOz5snv+PHgf+XzRvXrarkKnat2rVvKiN7ne76R+Zg2f7pT6tUF0Q4Tp81yOhrBNWXWAWWmfrDtKIuuI3qynv0kp6Rg647dRcul1NmfxCyGBqNV81u0XOUn9/WChs/X10e2N+WeNvcluRmajkSTBldPKgy5P05GxRhN0vWV+dmXOKPucHvrosGE0GbQdhgMvtKBo1EdM2wg6oq+TVvDMqzhZCAv3yRn8ros7H8cGDvfcdWR8BSbwn7cVwzmAf5+8rspA/NQJsoWI+xv3+5XZ9pD+sahXp1aSM+4ghVr10sZWI+sC0Z03cHZ9iGlbvtylPuBgf1kNCxPjHXsM3rb8HsY6eEYZukweRK0Gbpe2IreuYqzeuUupdqTUiBSnhhA0nPzkRUUigZDR6PaHV3gI7zJXDFQeAkvN6xmbTQaNhrBzdsgMSsH2SYzTHRMpOdpw0NxAnbIvwuFY2jwttimmPfMk9LZ+P6nQ1iw5A0tV3EO/3YUj82YLUOJNCSL31yJX48elx5wPeH9ER7Hqi+MA5X7rdXrsCl+p3zO5aBFy1bg3B8JiBLeMyMwhIassRi48k0mfLhlO2a99JqUjeWv/OAjDBn3GD77Yo/M6yxcsgkJDpbLDDPnvyLLpdFiGPRTUSYdRUYPCOVoWK+O7ICrhLHlb2ReypGWliHzuEMHYSzY+ehIvPj3N6QMLJ87w7nxaszjU7WcztGxXRthTGoiKztblqnLzXJnzH9Znshh+9CY6aSmpUnnhVEDHism7Bh0KCY/N1f+7Q4sm9//1AsLpDFkvX+793vk5OTCR+i1DqMQlI1Gcu3GrTIfE/XmfMJFhAQFybXi6wEdm7gRY/H8oteKBiTq7PcHDknd5FKFjifJ7QociDlws70p986v/inbS06cLDYYxzZpLAe7DzYXLh1Qr5iffYn9ng639fFL2g7WG43qlP8bi87tb5enIGhr+G+tSUlNw8vL3xZ9YnmRLHT8uIGRkwjiSTbltluaIio8HEdOnJRLWvoyN2Vav3mbXLKgU0Y44eNmTLOQY2P8Dix/Z62UgfV4UegO+4k7uNI+pWn78paby2tcPt8jJlGzX1lS1Db8ns2f7pJtz2gCnU5Lp2DmgsVFv1F/xtSmax+XJgTlWbazOKNXZYFjJ0W2rxdMIqXn5cO7dgNE39MLVe7oBENoGC4e/hmH1/wDp78Us7IrGYiJbYHKXbohrP3dyDT6C0eFd6PoR5CvVRbOdG1tnOWMwRoOTFRYwsGaxoTrlWwsW7AC2YiWcE3ZUsFrCMVi6JHpxWemFIvmbHnvrcL1fuHNc1ZE9A1LnA1QnrKkRtWqcvbOGYWlHEzcf8AZclRk4Y29uhzpGRk4duKUfFaWREdFyGUjzijL8ncGCyfMz+iH5JRUHPrlV+1pIWzHU2d/l+/DQ0PlK1mx9kMcFb+xaqUYPPfkJHnscvnCOehiMXN1Bw4O332/v5iuXBLOMJ9bwqhDvilfLqkMjOsuo3lM3OtRtXIl5OTmIEO0x/ViwoPDsV27oEnXk7EjBst2s8TT5HYW6sqOL/+p/VVIcmqq9q6QlsJoRlQIk3110pgHivUdJkbnWC+We5UIdW71R5ulHZJha+GUbhcOoD2dT0pJETPSXdpfhVBvcnLzihxaT7Ip1cR3GIXDSntpfeXD1EnjxUzYX+7fYP01bdhAOgocYNjfyhJX26c0bV+echOWzWXBX48c055c5bfjJ2TbM9LL6PBfBWf0qixw4KRoToUYOE0ipeblwbdeY1S6Jw7B1WoiO/ESft+zG8c/WIUz2zci6fAhGIMCEd2qHaI6d0OGfxAyTWbhonjJaExZwLIYtSEM0VeOiZbvSws7iSWF65yO/TRb0HvOEca/LLGctZeW8pDDEg5w5YFJ6EXGlUztL8dwEBj08CQsWr4C//31Nxkub9eqBV5+/hnprHAmdT3g0gCdGTqLPe/tIu/yYeJ7tt2/9+2XS1LXA67fc02Yjpu+HmwPT5Kb0KBz8641Jf0OR7i794B2gLCcmCjnBhtGqSy/2qNsipiMOVsvXBZkxKMscbd9SkN5yK1jLjBLJ0hRiCt65Q4l9KZCR8UkXlNFyhcDgq9wDhJPncS5XduRFP8hqvjkwfvIQZxetxIX9+9DXkY6DGImnOHjhWzd0XEz5Ea4kZOXXXEfAkOsHJy4L4WzwtLAcFzDurWlMWAoljAawxNGnCE9PnP2NREdprb39cXba9bJ/JxxcubJ/S6xwvsvS84nJMjXneK32ZKDaeBDE2UefXbs7+8nQ8c6rJPYpo1keNIdWD+sJy6plbZ+S4MuNzegtb2tufa0EMpeq3o1GZ7lMoQ1XBoaOWkK2vfsL0OtbDd66gPiums5yheG5ZuL78sTM6e09AwpJxOXAD7aGm932bGsoR7fFttMGgnuQeH+HF0/9D0tlniK3DoBYlBnNMEStn39OrWkXHRgnYVLXtwfwGXEhUveLNZn9NTy7jjMfbX4JXnU7cfGjkJkeAVpU9JFGZ3at5V2prQwCkBHxRNtyqXLSVIfeArFlhxM3F+x/+dfpMwc5LkRm/Vhye0tm8v9B67iavuUhvKUmzBSwvZlO1vTsG4dubTKtv/ltyPa0z8/zuhVWVCyyy8cJg564UYjso4dxrEta3Fu6/vI/nkvgrJSEWrwQrA5B74XTuPi55txZtMaJHwRj4DsTAQID5obZwt9LtcdFW6oemjYIGnMeEx19iuv439HjwsjUx1PT3xYPrcmvEIFaaAJlwbmTJ0sDXxicgq+3VsYVmXn+f2PCwgPC8PjD4+WRwsdhe249nYh4ZIMZ/F4IU8K0dDx+4fc3wvvL38V3e7qpOW+ChWd4cx7Ot5hd5mC67LcY9KpXVvMnf5kkey2OHL8pAyFUu4HBveXG5lY7spXF8p/566Xy3XfDNH5GZJeMPNpabT5G/lbeQJp5WtXj2w6w7+//xF/CAeEJx5GDxkg64zl8trmxbNnyj0n7PD6PguyeukreHPRXLnZWW/nw0eOyf0y3sKjZ0TtekAZaQR/PXpMbvgd/9RMaVg73z8UC5e+JYyl7WVHZ6ADbhaDNE81zJw80aYuUgaGWtmbuExx7OQp2S7Uxbj77r7GQXVVbtY1I1W8cnv3hjXoY7Fp2xXYpux7jGbyBA03qxLuQ5g3fQoa1KktBrEcuUzrCuwTHExGDx0ol71Kcq75+2g7uGGVtoQ2hbaF+sQolfUmTuInyuemV70v8JRF5/bt5NLgvv2FOutJNoU3LdMxbdaogTz9cted7bVProV9npuoKQdPz/D6AeoODzbwmgc92uQqzrZPaSlvuX/53xHZ19jO7JOUm+057dHxcsOst+hvB6ST537/v1lwRq8scdWmlHBPylEMijRgQMUQZAgDkiAG0SQxGw4Vg2AFoXAhwljSXHJRJ9tsRkpWDnLyuINFOC6BRoQJLza5wAuvnE7BmcAYIKL4PSkU2hYM8XMXNWGepfNfQPNmTbSZ4yypEDQW0x97RG78+3T3Hjy7cLHMb+tsuA5n8vrdBzqsKBoTWyFoYikLYUSHR+a4o98ayjX/9TfkxkZLqNCc8Vt3GOs7DZYteAHtWrW06WTQc7W8y8JWmZyJ0gngWX6eyrGU21n4P6LikT5bYXjLOqFTZH03iTU04Po+I9Yf76HgWq81jN5wk7DlrYhcmrBn0GicZom8ev05anti3T48RdYituk1d4TYuoeA+4K4D4SG1hrKfeLMWby3fqM8reAqdDbnz3hKLuNYY3m/QUn3ZVi2j6tyW/fR0tyvUBKO2p4nWCz7sa5XxPquBr2dLWVifj7n8WBbWPe1J8Y/hCF9e8p7N+a9ukxumuZvffvlF+WmVu5v4GkS1qUje8U+xzK5uVMfqDzJprBO6ODbW06zrEMexR43YohckrOEpwv5P43lZnJH92Y4wpn2cbbty1Nu2h5O1Bjps4ZtTz2ZPm+RbFNLbNmQsqI0ZTtrl/V6tYe1HjqjVzqu2hT7bibXVY2BSIEvLojZXbBwOOqHh6JVdCQaRUWgWlgwwoMChJMQiDDxGi0MT53ICmgUE4GGFcNRIyQYJuHpnzMJ58Dgz4VJrWDn4B0PnGEzfMpjxLoh4E5vznwI70thR7cHL/86Kmac819/s5iDQrgR7pkXF8nLZ0qz7vjxts/wjFBKy/xUVnYIHlHb86/v5DNLlvzjPWmAU9PTZV57PD17Ad7fuFWexNCPHdqDZW7dsavoiB1fGbLm0ThXQubW0FHghUk8xs3BjPCV9cgNy67C+mPIl+WwXQh/K50qfp/1tc2rhAPB2ZJlXTPEy2gY68sVw+MKm+J3yAgOodHTZSfsqNx4OXn8GJsz8NJCnXrjnbXF6sYWS99ZI0Op+p4htsvxU2dk/6COWeKq3NRjhnPZNtRtvncXtj1P2fH36TrF8qnvH2z6xK2lJ+rBNNEvqRfUD0f9jLZCn8XF79ojHRRC27Jaq0OeJuPFivbQ5WZ/tXRQiCfZFA4C1v3YHjyWvebjwt/PMqlfe/f/JCNw1B13cKZ9nKU85abzQWf1m/98XyQ3EyMJnFA9OuOFaxyUvwLO6JWOqzbFfiSF/+fi9ETU9c5BA0M+wsy58u4THb6T83191i8/sihKvL3i7YsEGHAoxwcZ/hWAwKunNsoLW562QuEu3Kzaq+tdOPDzYXlcmscQdUYN6ifv2OByQHnf3OosN6vcnkR5zooVCoVjHERSfAD/YJz2CsSXWb74OMWM9cn5Mq1LNolXk3xdlyT+ZtKey5QiPk81If6KN37I98cVvxDA4N4GJoXiRhLbpKEMrfPyr2aNG2pPC8OqvNeFyymcwXE/gidxs8qtUCgUxH4khZjN8DP4iOQLHy89ciI/KYqZ6NtibWEuKECeqQBZwgiaC1iA/bxlhYqkKMqD1+Y+hztvb213UzJDmN/s/UGe6PAkbla5PQkVSVEobhz2IylEzMBMXt7ILfBGDnyR4yUSX0XK1VIOfOynAh/kia8oYFTmOjgoCkV5Mf/vy6Xjy30Ilmuw3OPBS+i418kTB/qbVW6FQqEgjiMpCoVCoVAoFDcE4P8BEepn+OnZDcgAAAAASUVORK5CYII=\"}"
      ],
      "fileUploads": [],
      "cMarkNode": {}
    },
    "createdTimestamp": 1765632054454
  },
  {
    "id": 9,
    "author": "model",
    "payload": {
      "type": "thinking",
      "text": "**Analyzing the Code**\n\nI'm currently focused on the `App.tsx` file, as it seems the primary suspect for the \"Expected closing tag\" error. After a quick scan, I've confirmed that the `App` function itself appears structurally sound. This prompts me to examine potential issues related to its components or imports, digging deeper into its internal structure.\n\n\n**Examining Component Closure**\n\nI've meticulously reviewed the component closures within `App.tsx`, especially focusing on `ReportView`, which concludes the file. I've re-examined the code block provided, verifying the correct closure of the `ReportView` component. It appears to terminate correctly. There's nothing trailing after the component definition, which is a good sign. This suggests the error lies elsewhere, potentially deeper within imported components or the structure of how these components are integrated.\n\n\n**Identifying Potential Omission**\n\nI'm now revisiting `App.tsx` again, specifically the very end. I'm focusing on the possibility of a missed closing tag for `ReportView` or a structural issue at the file's termination. The error message, \"Expected closing tag. Unexpected end of file,\" is guiding my investigation towards this area. I'm re-analyzing the final lines of the file to see if there's any discrepancy or incomplete structure that could be triggering the error.\n\n\n**Scrutinizing Component Placement**\n\nI'm now carefully examining the placement of `SleepInputView` in relation to `ReportView` in `App.tsx`. The code snippets suggest a clean definition and closure for `ReportView` after `SleepInputView`. However, the error message indicates a file-level issue. Could an unexpected character or missing structure be causing the parsing to fail prematurely before `ReportView` is reached? I'm re-reading the preceding code to ensure complete syntactic alignment between components, including their closures and possible imports, hoping to find an overlooked detail that might have slipped past earlier reviews.\n\n\n**Investigating Syntax Anomalies**\n\nI'm now zeroing in on a potential syntax gap, focusing on the `SleepInputView` component. Although the code structure appears correct at a glance, I'm carefully re-evaluating the component's closure and its integration within the larger `App` function. I am also checking that there is not an unexpected character following the `return` statement, as well as the missing semi-colon. I'm verifying the alignment of HTML tags and ensuring that the component definitions adhere to proper TypeScript syntax. Specifically, I'm examining any possible omissions or misplaced elements that could be causing the parser to flag an error.\n\n\n**Examining the Component Structure**\n\nI've re-examined the code block focusing on the `main` element that wraps the tabbed views, along with its conditional rendering. I've confirmed that all the components including `DashboardView` and `ReportView` are properly closed. I'm taking a hard look at the `main` element and the wrapping `div` elements, checking for any misplaced or missing tags. The logic within these sections appear complete as well, so I'll also try a deep-dive check of the imports, hoping to rule out a missing or extra dependency.\n\n\n**Uncovering Tag Discrepancies**\n\nI'm now carefully reviewing `App.tsx` and focusing on all JSX tags and the possibility of incorrect nesting or missing closing tags within the `DashboardView` component. The error suggests an unclosed tag. I'm especially focusing on any tags that might be missing their corresponding closing tags, or that could be incorrectly nested, leading to a parsing discrepancy. I'm also ensuring that all components are correctly closed and that there are no unmatched tags within the nested structure.\n\n\n**Inspecting Challenge Rendering**\n\nI'm presently focusing on the `gameState.challenges.map` section of `DashboardView`, scrutinizing its rendering logic within the `return` statement. I'm checking for any potential syntax errors or mismatched tags within the loop that could be disrupting the file's parsing. Ensuring each challenge is correctly rendered and closed is a primary concern. I'm also ensuring the array is correctly looped over. It seems the code is well-formed, but I'll continue reviewing for anything that may cause an issue.\n\n\n**Reviewing Chart Components**\n\nI'm presently focusing on the chart components, `StepsChart`, `NutritionPieChart`, and `SleepBarChart`, within `DashboardView`. Everything looks good within the provided blocks, and I'm re-validating the closures of `div` tags as well as ensuring that the structure and props for the chart components are set correctly. I'm also ensuring the data passed to the charts is the right type. I am looking deeply into the chart components.\n\n\n**Detecting Truncation Possibility**\n\nI'm now considering the possibility of code truncation. The user provided what *they believe* is the complete `App.tsx` file, but the error suggests an unexpected end. It's plausible the file got cut off during transmission or pasting, or that the file had unexpected non-visible characters. I'm focusing on the file's final characters, looking for a missing closing tag or an incomplete structural element due to a potential truncation issue from the end of file content. I'm double-checking the file's integrity and comparing against the file I generated to confirm there's no unintentional omissions.\n\n\n**Verifying Full File Integrity**\n\nI've re-examined the code block focusing on the `main` element that wraps the tabbed views, along with its conditional rendering. I've confirmed that all the components including `DashboardView` and `ReportView` are properly closed. I'm taking a hard look at the `main` element and the wrapping `div` elements, checking for any misplaced or missing tags. The logic within these sections appear complete as well, so I'll also try a deep-dive check of the imports, hoping to rule out a missing or extra dependency. I've carefully reviewed the entire `App.tsx` file from start to finish. I've also verified that there were no additional components or unexpected tags. I've completely regenerated and re-validated the code.\n\n\n\n**Investigating Possible Truncation**\n\nI'm now focusing on the very end of the file, specifically the closing of the last `</div>`. The provided file appears complete, but the error suggests an unexpected end.  I'm re-validating the file's structure and contents against what I've generated, looking for any possible truncation or incomplete element that could be the source of this problem. I am also checking that there is not an unexpected character following the `return` statement, as well as the missing semi-colon.\n\n\n**Validating File Completion**\n\nI'm presently focusing on the provided `App.tsx` file to see if it's identical to the one I have generated. I'll make sure there are no unintentional omissions. I suspect that the issue is within the file's structure.\n\n\n**Reconstructing the Structure**\n\nI'm focusing now on the closing braces within the `SleepBarChart` component to ensure proper syntax. I'm also re-validating that everything looks good within `App.tsx`, especially the conditional rendering of the components. I am ensuring that the `}` is present to close the component. I will also be verifying the imports.\n\n\n**Detecting Potential Discrepancy**\n\nI'm now reviewing the user's provided `AnalysisCharts.tsx`, specifically `SleepBarChart`, which seems structurally sound. However, the error continues to point towards `App.tsx` and its terminal point. I've re-examined the likely problematic `SleepInputView`, particularly the `input` tags and their potential impact on the overall parsing due to the closing of the JSX tags. I am considering that an error could have happened there and may be causing the problem, given the nature of the \"Expected closing tag\" error, even though the other file seems complete.\n\n\n\n**Regenerating & Validating**\n\nI'm now focusing on a complete regeneration of `App.tsx` from scratch, ensuring perfect alignment. I will be verifying imports and overall file structure.\n\n\n**Verifying Component Imports**\n\nI'm presently focusing on the imports within `App.tsx`, cross-referencing them with the user's provided snippets to ensure all imported components are correctly declared and available within the correct scope. I'm verifying the case of the component name and the path of the imports. Also, I am ensuring that the components that are used are imported and the components which aren't used are not imported.\n\n\\n\\nI am re-validating the component imports in `App.tsx` and verifying the path for components. Also, I'm ensuring that they're all imported with the right capitalization. I'm also going through and making sure there are no unused imports that might cause a problem.\n\n\n**Validating Full Regeneration**\n\nI'm verifying that the file matches the regenarated code with correct structure. I'm ensuring everything is exactly the same, character for character. I'm also ensuring the imports and component calls are the same.\n\\n\\nI am re-validating the regenerated `App.tsx` file for the integrity of its structure, including correct import statements, component placement, and appropriate closing tags. I also am ensuring no unexpected characters or truncation exist, especially at the file's end.\n\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": 1765632054454,
    "doneTimestamp": 1765632131473
  },
  {
    "id": 10,
    "author": "model",
    "payload": {
      "type": "text",
      "text": "The \"Expected closing tag\" error suggests that `App.tsx` may have been truncated or contains a malformed tag structure in the current environment. This often happens if the file content wasn't fully copied or generated.\n\nI will regenerate the complete `App.tsx` file to ensure all components and tags are properly closed.\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": 1765632131473,
    "doneTimestamp": 1765632131538
  },
  {
    "id": 11,
    "author": "model",
    "payload": {
      "type": "generationTable",
      "entries": [
        {
          "path": "App.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Fix potential closing tag error by regenerating the full component file.",
          "diffs": [
            {
              "target": "",
              "replacement": "import React, { useState, useEffect } from 'react';\nimport { DietData, ExerciseData, SleepData, AdviceItem, GamificationState } from './types';\nimport { analyzeFoodImage, generateWeeklyReportAI } from './services/geminiService';\nimport { calculateGamificationState } from './services/gamificationLogic';\nimport { StepsChart, NutritionPieChart, SleepBarChart } from './components/AnalysisCharts';\n\n// --- Helper: Generate Mock Data ---\nconst generateMockData = () => {\n  const dates = Array.from({ length: 7 }, (_, i) => {\n    const d = new Date();\n    d.setDate(d.getDate() - (6 - i));\n    return d.toISOString().split('T')[0];\n  });\n\n  const diets: DietData[] = dates.map(date => ({\n    id: Math.random().toString(),\n    date,\n    calorieIntake: Math.floor(Math.random() * 600 + 400),\n    vegRatio: Math.random() * 0.4 + 0.1, // 0.1 - 0.5\n    proteinRatio: Math.random() * 0.3 + 0.1,\n    starchRatio: Math.random() * 0.4 + 0.2,\n    sugaryDrinksCount: Math.random() > 0.7 ? 1 : 0,\n    friedFoodCount: Math.random() > 0.8 ? 1 : 0,\n  }));\n\n  const exercises: ExerciseData[] = dates.map(date => ({\n    id: Math.random().toString(),\n    date,\n    dailySteps: Math.floor(Math.random() * 5000 + 4000), // 4000 - 9000\n    moderateExerciseMinutes: Math.floor(Math.random() * 40),\n    totalSittingMinutes: Math.floor(Math.random() * 100 + 300),\n  }));\n\n  const sleeps: SleepData[] = dates.map(date => ({\n    id: Math.random().toString(),\n    date,\n    bedTime: \"23:45\",\n    wakeTime: \"06:30\",\n    sleepDuration: 6.5 + Math.random(),\n    usedPhoneBeforeBed: Math.random() > 0.5,\n  }));\n\n  return { diets, exercises, sleeps };\n};\n\n// --- Core Analysis Logic Functions ---\n\nconst analyzeDiet = (weeklyData: DietData[]): AdviceItem[] => {\n  const advice: AdviceItem[] = [];\n  if (weeklyData.length === 0) return advice;\n\n  const avgVeg = weeklyData.reduce((sum, d) => sum + d.vegRatio, 0) / weeklyData.length;\n  const avgProtein = weeklyData.reduce((sum, d) => sum + d.proteinRatio, 0) / weeklyData.length;\n\n  if (avgVeg < 0.5 || avgProtein < 0.25) {\n    advice.push({\n      category: 'Diet',\n      title: '營養比例失衡',\n      description: '建議採用「健康餐盤法」：1/2 蔬菜、1/4 蛋白質、1/4 澱粉。',\n      priority: 'High'\n    });\n  }\n\n  const totalSugary = weeklyData.reduce((sum, d) => sum + d.sugaryDrinksCount, 0);\n  const avgSugary = totalSugary / weeklyData.length;\n  if (avgSugary > 0.57) {\n    advice.push({\n      category: 'Diet',\n      title: '含糖飲料攝取過多',\n      description: '提醒每週至少 3 天不喝含糖飲料，多喝水。',\n      priority: 'Medium'\n    });\n  }\n\n  return advice;\n};\n\nconst analyzeExercise = (weeklyData: ExerciseData[]): AdviceItem[] => {\n  const advice: AdviceItem[] = [];\n  if (weeklyData.length === 0) return advice;\n\n  const avgSteps = weeklyData.reduce((sum, d) => sum + d.dailySteps, 0) / weeklyData.length;\n  if (avgSteps < 8000) {\n    advice.push({\n      category: 'Exercise',\n      title: '活動量不足',\n      description: `目前平均步數 ${Math.round(avgSteps)} 步。建議每日目標：8,000–10,000 步。`,\n      priority: 'Medium'\n    });\n  }\n\n  const totalModMin = weeklyData.reduce((sum, d) => sum + d.moderateExerciseMinutes, 0);\n  if (totalModMin < 180) {\n    advice.push({\n      category: 'Exercise',\n      title: '中等強度運動不足',\n      description: '每週建議至少 3 次，共 180 分鐘的中等強度運動。',\n      priority: 'High'\n    });\n  }\n\n  const avgSitting = weeklyData.reduce((sum, d) => sum + d.totalSittingMinutes, 0) / weeklyData.length;\n  if (avgSitting > 480) {\n    advice.push({\n      category: 'Exercise',\n      title: '久坐時間過長',\n      description: '建議每久坐 50 分鐘後，起身活動 5 分鐘。',\n      priority: 'Low'\n    });\n  }\n\n  return advice;\n};\n\nconst analyzeSleep = (weeklyData: SleepData[]): AdviceItem[] => {\n  const advice: AdviceItem[] = [];\n  if (weeklyData.length === 0) return advice;\n\n  const lateNights = weeklyData.filter(d => {\n    const [hour] = d.bedTime.split(':').map(Number);\n    return (hour >= 0 && hour < 5) || (hour === 23 && parseInt(d.bedTime.split(':')[1]) > 30);\n  }).length;\n\n  if (lateNights > 2) {\n    advice.push({\n      category: 'Sleep',\n      title: '頻繁熬夜',\n      description: '檢測到入睡時間較晚，建議養成規律作息，目標 23:00 前就寢。',\n      priority: 'High'\n    });\n  }\n\n  const avgSleep = weeklyData.reduce((sum, d) => sum + d.sleepDuration, 0) / weeklyData.length;\n  if (avgSleep < 7.5) {\n    advice.push({\n      category: 'Sleep',\n      title: '睡眠時數不足',\n      description: `平均睡眠僅 ${avgSleep.toFixed(1)} 小時。高中生建議每晚睡足 7.5 - 8.5 小時。`,\n      priority: 'High'\n    });\n  }\n\n  const phoneDays = weeklyData.filter(d => d.usedPhoneBeforeBed).length;\n  if (phoneDays > 3) {\n    advice.push({\n      category: 'Sleep',\n      title: '睡前使用手機',\n      description: '藍光會影響褪黑激素分泌，建議睡前 30 分鐘不要使用手機。',\n      priority: 'Medium'\n    });\n  }\n\n  return advice;\n};\n\n// --- Main App Component ---\n\nenum Tab {\n  DASHBOARD = 'DASHBOARD',\n  DIET = 'DIET',\n  EXERCISE = 'EXERCISE',\n  SLEEP = 'SLEEP',\n  REPORT = 'REPORT'\n}\n\nexport default function App() {\n  const [activeTab, setActiveTab] = useState<Tab>(Tab.DASHBOARD);\n  \n  // Data State\n  const [dietData, setDietData] = useState<DietData[]>([]);\n  const [exerciseData, setExerciseData] = useState<ExerciseData[]>([]);\n  const [sleepData, setSleepData] = useState<SleepData[]>([]);\n  \n  // Report State\n  const [adviceList, setAdviceList] = useState<AdviceItem[]>([]);\n  const [aiReportSummary, setAiReportSummary] = useState<string>('');\n  const [isGeneratingReport, setIsGeneratingReport] = useState(false);\n\n  // Gamification State\n  const [gameState, setGameState] = useState<GamificationState>({\n      totalPoints: 0,\n      level: 1,\n      progressToNextLevel: 0,\n      badges: [],\n      challenges: []\n  });\n\n  // Initialize with some mock data on first load\n  useEffect(() => {\n    const { diets, exercises, sleeps } = generateMockData();\n    setDietData(diets);\n    setExerciseData(exercises);\n    setSleepData(sleeps);\n  }, []);\n\n  // Recalculate advice AND Gamification whenever data changes\n  useEffect(() => {\n    const dietAdvice = analyzeDiet(dietData);\n    const exerciseAdvice = analyzeExercise(exerciseData);\n    const sleepAdvice = analyzeSleep(sleepData);\n    setAdviceList([...dietAdvice, ...exerciseAdvice, ...sleepAdvice]);\n\n    const newGameState = calculateGamificationState(dietData, exerciseData, sleepData);\n    setGameState(newGameState);\n\n  }, [dietData, exerciseData, sleepData]);\n\n  // --- Input Handlers ---\n\n  const handleDietSubmit = (data: DietData) => {\n    setDietData(prev => [...prev, data]);\n    setActiveTab(Tab.DASHBOARD);\n  };\n\n  const handleExerciseSubmit = (data: ExerciseData) => {\n    setExerciseData(prev => [...prev, data]);\n    setActiveTab(Tab.DASHBOARD);\n  };\n\n  const handleSleepSubmit = (data: SleepData) => {\n    setSleepData(prev => [...prev, data]);\n    setActiveTab(Tab.DASHBOARD);\n  };\n\n  const handleGenerateReport = async () => {\n    setIsGeneratingReport(true);\n    try {\n      const summary = await generateWeeklyReportAI(dietData, exerciseData, sleepData, adviceList);\n      setAiReportSummary(summary);\n    } catch (e) {\n      setAiReportSummary(\"報告生成失敗，請檢查網路連線。\");\n    } finally {\n      setIsGeneratingReport(false);\n    }\n  };\n\n  // --- Render Views ---\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 text-gray-800 pb-20 font-sans\">\n      {/* Header */}\n      <header className=\"bg-white shadow-sm sticky top-0 z-20\">\n        <div className=\"max-w-md mx-auto px-4 py-4 flex justify-between items-center\">\n          <h1 className=\"text-xl font-bold text-primary flex items-center\">\n            <i className=\"fa-solid fa-heart-pulse mr-2\"></i>\n            AI 智慧健康管理\n          </h1>\n          <button \n            onClick={() => {\n               const { diets, exercises, sleeps } = generateMockData();\n               setDietData(diets); setExerciseData(exercises); setSleepData(sleeps);\n            }}\n            className=\"text-xs text-gray-400 hover:text-primary\"\n          >\n            重置數據\n          </button>\n        </div>\n      </header>\n\n      {/* Main Content Area */}\n      <main className=\"max-w-md mx-auto p-4 space-y-6\">\n        \n        {activeTab === Tab.DASHBOARD && (\n          <DashboardView \n            dietData={dietData} \n            exerciseData={exerciseData} \n            sleepData={sleepData} \n            adviceCount={adviceList.length}\n            gameState={gameState}\n            onNavigate={setActiveTab}\n          />\n        )}\n\n        {activeTab === Tab.DIET && <DietInputView onSave={handleDietSubmit} onCancel={() => setActiveTab(Tab.DASHBOARD)} />}\n        {activeTab === Tab.EXERCISE && <ExerciseInputView onSave={handleExerciseSubmit} onCancel={() => setActiveTab(Tab.DASHBOARD)} />}\n        {activeTab === Tab.SLEEP && <SleepInputView onSave={handleSleepSubmit} onCancel={() => setActiveTab(Tab.DASHBOARD)} />}\n        \n        {activeTab === Tab.REPORT && (\n          <ReportView \n            adviceList={adviceList} \n            summary={aiReportSummary} \n            isGenerating={isGeneratingReport} \n            onGenerate={handleGenerateReport}\n          />\n        )}\n\n      </main>\n\n      {/* Bottom Navigation */}\n      <nav className=\"fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-10\">\n        <div className=\"max-w-md mx-auto flex justify-around py-3\">\n          <NavButton icon=\"fa-house\" label=\"首頁\" active={activeTab === Tab.DASHBOARD} onClick={() => setActiveTab(Tab.DASHBOARD)} />\n          <NavButton icon=\"fa-carrot\" label=\"飲食\" active={activeTab === Tab.DIET} onClick={() => setActiveTab(Tab.DIET)} />\n          <NavButton icon=\"fa-person-running\" label=\"運動\" active={activeTab === Tab.EXERCISE} onClick={() => setActiveTab(Tab.EXERCISE)} />\n          <NavButton icon=\"fa-bed\" label=\"睡眠\" active={activeTab === Tab.SLEEP} onClick={() => setActiveTab(Tab.SLEEP)} />\n          <NavButton icon=\"fa-file-medical\" label=\"週報\" active={activeTab === Tab.REPORT} onClick={() => setActiveTab(Tab.REPORT)} />\n        </div>\n      </nav>\n    </div>\n  );\n}\n\n// --- Sub-Components ---\n\nconst NavButton = ({ icon, label, active, onClick }: { icon: string, label: string, active: boolean, onClick: () => void }) => (\n  <button onClick={onClick} className={`flex flex-col items-center w-full ${active ? 'text-primary' : 'text-gray-400'}`}>\n    <i className={`fa-solid ${icon} text-lg mb-1`}></i>\n    <span className=\"text-xs font-medium\">{label}</span>\n  </button>\n);\n\nconst DashboardView: React.FC<any> = ({ dietData, exerciseData, sleepData, adviceCount, gameState, onNavigate }) => {\n  return (\n    <div className=\"space-y-6 animate-fade-in\">\n      \n      {/* --- Gamification Section --- */}\n      <div className=\"bg-white rounded-xl shadow-sm border border-gray-100 p-4\">\n          <div className=\"flex justify-between items-end mb-2\">\n              <div>\n                  <h2 className=\"text-lg font-bold text-gray-800\">等級 {gameState.level}</h2>\n                  <span className=\"text-xs text-gray-500\">總積分: {gameState.totalPoints}</span>\n              </div>\n              <span className=\"text-xs font-bold text-primary\">{gameState.progressToNextLevel}%</span>\n          </div>\n          {/* Progress Bar */}\n          <div className=\"w-full bg-gray-100 rounded-full h-2.5 mb-4\">\n              <div className=\"bg-primary h-2.5 rounded-full transition-all duration-500\" style={{ width: `${gameState.progressToNextLevel}%` }}></div>\n          </div>\n          \n          {/* Badges Preview */}\n          <div className=\"flex space-x-3 overflow-x-auto no-scrollbar pb-2\">\n              {gameState.badges.map((badge: any) => (\n                  <div key={badge.id} className={`flex-shrink-0 flex flex-col items-center justify-center w-16 h-16 rounded-lg border ${badge.isUnlocked ? 'border-amber-200 bg-amber-50' : 'border-gray-100 bg-gray-50 opacity-50'}`}>\n                      <i className={`fa-solid ${badge.icon} text-xl mb-1 ${badge.isUnlocked ? badge.color : 'text-gray-300'}`}></i>\n                      <span className=\"text-[10px] text-gray-600 truncate w-14 text-center\">{badge.name}</span>\n                  </div>\n              ))}\n          </div>\n      </div>\n\n      {/* --- Active Challenges --- */}\n      <div className=\"space-y-3\">\n          <h3 className=\"font-bold text-gray-700 flex items-center\">\n              <i className=\"fa-solid fa-trophy text-accent mr-2\"></i> 本週挑戰\n          </h3>\n          {gameState.challenges.map((challenge: any) => (\n              <div key={challenge.id} className=\"bg-white p-3 rounded-lg border border-gray-100 shadow-sm flex items-center space-x-3\">\n                  <div className={`w-10 h-10 rounded-full flex items-center justify-center ${challenge.isCompleted ? 'bg-green-100 text-green-600' : 'bg-blue-50 text-blue-500'}`}>\n                      <i className={`fa-solid ${challenge.type === 'Diet' ? 'fa-carrot' : challenge.type === 'Exercise' ? 'fa-person-running' : 'fa-bed'}`}></i>\n                  </div>\n                  <div className=\"flex-1\">\n                      <div className=\"flex justify-between\">\n                          <h4 className=\"text-sm font-bold text-gray-800\">{challenge.title}</h4>\n                          <span className=\"text-xs text-gray-500\">{challenge.current} / {challenge.target} {challenge.unit}</span>\n                      </div>\n                      <div className=\"w-full bg-gray-100 rounded-full h-1.5 mt-1\">\n                          <div className={`h-1.5 rounded-full ${challenge.isCompleted ? 'bg-green-500' : 'bg-blue-500'}`} \n                               style={{ width: `${Math.min(100, (challenge.current / challenge.target) * 100)}%` }}></div>\n                      </div>\n                  </div>\n              </div>\n          ))}\n      </div>\n\n      {/* Status Cards */}\n      <div className=\"grid grid-cols-2 gap-4\">\n        <div className=\"bg-gradient-to-br from-emerald-400 to-emerald-600 text-white p-4 rounded-xl shadow-lg\"\n             onClick={() => onNavigate(Tab.REPORT)}>\n          <div className=\"flex justify-between items-start\">\n            <span className=\"text-sm font-medium opacity-90\">待處理建議</span>\n            <i className=\"fa-solid fa-bell opacity-80\"></i>\n          </div>\n          <div className=\"mt-2 text-3xl font-bold\">{adviceCount}</div>\n          <div className=\"text-xs opacity-75 mt-1\">點擊查看建議</div>\n        </div>\n        <div className=\"bg-white p-4 rounded-xl shadow-md border border-gray-100 flex flex-col justify-center items-center text-center\">\n             <span className=\"text-gray-500 text-sm mb-1\">今日紀錄</span>\n             <span className=\"text-primary font-bold text-lg\">\n                {(new Date()).toISOString().split('T')[0].slice(5)}\n             </span>\n             <span className=\"text-xs text-gray-400 mt-1\">保持健康好習慣！</span>\n        </div>\n      </div>\n\n      {/* Charts */}\n      <div className=\"space-y-4\">\n        <StepsChart data={exerciseData} />\n        <NutritionPieChart data={dietData} />\n        <SleepBarChart data={sleepData} />\n      </div>\n    </div>\n  );\n};\n\n// --- Input Views ---\n\nconst DietInputView: React.FC<{ onSave: (d: DietData) => void, onCancel: () => void }> = ({ onSave, onCancel }) => {\n  const [analyzing, setAnalyzing] = useState(false);\n  const [imagePreview, setImagePreview] = useState<string | null>(null);\n  const [formData, setFormData] = useState<Partial<DietData>>({\n    date: new Date().toISOString().split('T')[0],\n    sugaryDrinksCount: 0,\n    friedFoodCount: 0\n  });\n\n  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (!file) return;\n\n    // Preview\n    const reader = new FileReader();\n    reader.onloadend = async () => {\n      const base64 = reader.result as string;\n      setImagePreview(base64);\n      \n      // Analyze with Gemini\n      setAnalyzing(true);\n      try {\n        const base64Data = base64.split(',')[1]; // Remove data:image/jpeg;base64,\n        const result = await analyzeFoodImage(base64Data);\n        setFormData(prev => ({\n          ...prev,\n          ...result\n        }));\n      } catch (error) {\n        alert(\"分析失敗，請手動輸入數據\");\n      } finally {\n        setAnalyzing(false);\n      }\n    };\n    reader.readAsDataURL(file);\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (formData.calorieIntake !== undefined) {\n      onSave({\n        id: Math.random().toString(),\n        date: formData.date!,\n        calorieIntake: formData.calorieIntake!,\n        vegRatio: formData.vegRatio || 0,\n        proteinRatio: formData.proteinRatio || 0,\n        starchRatio: formData.starchRatio || 0,\n        sugaryDrinksCount: formData.sugaryDrinksCount || 0,\n        friedFoodCount: formData.friedFoodCount || 0\n      });\n    } else {\n        alert(\"請輸入完整的飲食資訊或上傳照片\");\n    }\n  };\n\n  return (\n    <div className=\"bg-white p-6 rounded-xl shadow-md space-y-4 animate-fade-in-up\">\n      <h2 className=\"text-xl font-bold text-gray-800\">新增飲食紀錄</h2>\n      \n      <div className=\"space-y-2\">\n        <label className=\"block text-sm font-medium text-gray-700\">拍照/上傳食物 (Gemini AI 分析)</label>\n        <div className=\"relative\">\n          <input type=\"file\" accept=\"image/*\" onChange={handleFileChange} className=\"hidden\" id=\"food-upload\" />\n          <label htmlFor=\"food-upload\" className=\"flex flex-col items-center justify-center w-full h-40 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 bg-gray-50 overflow-hidden\">\n            {imagePreview ? (\n              <img src={imagePreview} alt=\"Preview\" className=\"w-full h-full object-cover\" />\n            ) : (\n              <>\n                <i className=\"fa-solid fa-camera text-2xl text-gray-400 mb-2\"></i>\n                <span className=\"text-sm text-gray-500\">點擊上傳</span>\n              </>\n            )}\n          </label>\n        </div>\n      </div>\n\n      {analyzing && (\n        <div className=\"flex items-center text-primary space-x-2\">\n            <i className=\"fa-solid fa-circle-notch fa-spin\"></i>\n            <span>AI 正在分析營養成分...</span>\n        </div>\n      )}\n\n      <form onSubmit={handleSubmit} className=\"space-y-4\">\n        <div>\n           <label className=\"text-xs text-gray-500\">日期</label>\n           <input type=\"date\" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} className=\"w-full border rounded p-2\" />\n        </div>\n        \n        <div className=\"grid grid-cols-2 gap-4\">\n            <div>\n                <label className=\"text-xs text-gray-500\">熱量 (kcal)</label>\n                <input type=\"number\" value={formData.calorieIntake || ''} onChange={e => setFormData({...formData, calorieIntake: Number(e.target.value)})} className=\"w-full border rounded p-2\" placeholder=\"0\" />\n            </div>\n            <div>\n                 <label className=\"text-xs text-gray-500\">含糖飲料(次)</label>\n                 <input type=\"number\" value={formData.sugaryDrinksCount} onChange={e => setFormData({...formData, sugaryDrinksCount: Number(e.target.value)})} className=\"w-full border rounded p-2\" />\n            </div>\n        </div>\n\n        <div>\n             <label className=\"text-xs text-gray-500 block mb-1\">餐盤比例 (0-1)</label>\n             <div className=\"flex space-x-2\">\n                <input type=\"number\" step=\"0.1\" max=\"1\" placeholder=\"菜\" value={formData.vegRatio || ''} onChange={e => setFormData({...formData, vegRatio: Number(e.target.value)})} className=\"w-full border rounded p-2 bg-green-50\" />\n                <input type=\"number\" step=\"0.1\" max=\"1\" placeholder=\"肉\" value={formData.proteinRatio || ''} onChange={e => setFormData({...formData, proteinRatio: Number(e.target.value)})} className=\"w-full border rounded p-2 bg-red-50\" />\n                <input type=\"number\" step=\"0.1\" max=\"1\" placeholder=\"飯\" value={formData.starchRatio || ''} onChange={e => setFormData({...formData, starchRatio: Number(e.target.value)})} className=\"w-full border rounded p-2 bg-yellow-50\" />\n             </div>\n        </div>\n\n        <div className=\"flex space-x-3 pt-2\">\n             <button type=\"button\" onClick={onCancel} className=\"flex-1 py-2 rounded-lg border border-gray-300 text-gray-600\">取消</button>\n             <button type=\"submit\" className=\"flex-1 py-2 rounded-lg bg-primary text-white font-bold shadow-md hover:bg-emerald-600\">儲存</button>\n        </div>\n      </form>\n    </div>\n  );\n};\n\nconst ExerciseInputView: React.FC<{ onSave: (d: ExerciseData) => void, onCancel: () => void }> = ({ onSave, onCancel }) => {\n    const [data, setData] = useState<Partial<ExerciseData>>({\n        date: new Date().toISOString().split('T')[0],\n        dailySteps: 0,\n        moderateExerciseMinutes: 0,\n        totalSittingMinutes: 0\n    });\n\n    return (\n        <div className=\"bg-white p-6 rounded-xl shadow-md space-y-4 animate-fade-in-up\">\n             <h2 className=\"text-xl font-bold text-gray-800\">新增運動紀錄</h2>\n             <div className=\"space-y-4\">\n                 <div>\n                    <label className=\"text-xs text-gray-500\">日期</label>\n                    <input type=\"date\" value={data.date} onChange={e => setData({...data, date: e.target.value})} className=\"w-full border rounded p-2\" />\n                 </div>\n                 <div>\n                    <label className=\"text-xs text-gray-500\">今日步數</label>\n                    <input type=\"number\" value={data.dailySteps || ''} onChange={e => setData({...data, dailySteps: Number(e.target.value)})} className=\"w-full border rounded p-2\" placeholder=\"ex: 8000\" />\n                 </div>\n                 <div>\n                    <label className=\"text-xs text-gray-500\">中等強度運動 (分鐘)</label>\n                    <input type=\"number\" value={data.moderateExerciseMinutes || ''} onChange={e => setData({...data, moderateExerciseMinutes: Number(e.target.value)})} className=\"w-full border rounded p-2\" placeholder=\"ex: 30\" />\n                 </div>\n                 <div>\n                    <label className=\"text-xs text-gray-500\">久坐時間 (分鐘)</label>\n                    <input type=\"number\" value={data.totalSittingMinutes || ''} onChange={e => setData({...data, totalSittingMinutes: Number(e.target.value)})} className=\"w-full border rounded p-2\" placeholder=\"ex: 480\" />\n                 </div>\n                 <div className=\"flex space-x-3 pt-2\">\n                    <button onClick={onCancel} className=\"flex-1 py-2 rounded-lg border border-gray-300 text-gray-600\">取消</button>\n                    <button onClick={() => onSave({id: Math.random().toString(), ...data} as ExerciseData)} className=\"flex-1 py-2 rounded-lg bg-secondary text-white font-bold shadow-md hover:bg-blue-600\">儲存</button>\n                </div>\n             </div>\n        </div>\n    )\n}\n\nconst SleepInputView: React.FC<{ onSave: (d: SleepData) => void, onCancel: () => void }> = ({ onSave, onCancel }) => {\n    const [data, setData] = useState<Partial<SleepData>>({\n        date: new Date().toISOString().split('T')[0],\n        bedTime: '23:00',\n        wakeTime: '07:00',\n        usedPhoneBeforeBed: false\n    });\n\n    const calculateDuration = () => {\n        const start = new Date(`2000-01-01T${data.bedTime}`);\n        const end = new Date(`2000-01-01T${data.wakeTime}`);\n        if (end < start) end.setDate(end.getDate() + 1);\n        const diff = (end.getTime() - start.getTime()) / 1000 / 60 / 60;\n        return diff;\n    }\n\n    return (\n        <div className=\"bg-white p-6 rounded-xl shadow-md space-y-4 animate-fade-in-up\">\n             <h2 className=\"text-xl font-bold text-gray-800\">新增睡眠紀錄</h2>\n             <div className=\"space-y-4\">\n                 <div>\n                    <label className=\"text-xs text-gray-500\">日期</label>\n                    <input type=\"date\" value={data.date} onChange={e => setData({...data, date: e.target.value})} className=\"w-full border rounded p-2\" />\n                 </div>\n                 <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                        <label className=\"text-xs text-gray-500\">入睡時間</label>\n                        <input type=\"time\" value={data.bedTime} onChange={e => setData({...data, bedTime: e.target.value})} className=\"w-full border rounded p-2\" />\n                    </div>\n                    <div>\n                        <label className=\"text-xs text-gray-500\">起床時間</label>\n                        <input type=\"time\" value={data.wakeTime} onChange={e => setData({...data, wakeTime: e.target.value})} className=\"w-full border rounded p-2\" />\n                    </div>\n                 </div>\n                 \n                 <div className=\"flex items-center space-x-2 py-2\">\n                    <input type=\"checkbox\" id=\"phone\" checked={data.usedPhoneBeforeBed} onChange={e => setData({...data, usedPhoneBeforeBed: e.target.checked})} className=\"w-5 h-5 text-primary rounded\" />\n                    <label htmlFor=\"phone\" className=\"text-gray-700\">睡前 30 分鐘使用手機</label>\n                 </div>\n\n                 <div className=\"flex space-x-3 pt-2\">\n                    <button onClick={onCancel} className=\"flex-1 py-2 rounded-lg border border-gray-300 text-gray-600\">取消</button>\n                    <button onClick={() => onSave({id: Math.random().toString(), sleepDuration: calculateDuration(), ...data} as SleepData)} className=\"flex-1 py-2 rounded-lg bg-accent text-white font-bold shadow-md hover:bg-amber-600\">儲存</button>\n                </div>\n             </div>\n        </div>\n    )\n}\n\nconst ReportView: React.FC<{ adviceList: AdviceItem[], summary: string, isGenerating: boolean, onGenerate: () => void }> = ({ adviceList, summary, isGenerating, onGenerate }) => {\n    return (\n        <div className=\"space-y-6 animate-fade-in pb-12\">\n            \n            {/* AI Report Card */}\n            <div className=\"bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-6 rounded-xl shadow-lg\">\n                <div className=\"flex justify-between items-center mb-4\">\n                     <h2 className=\"text-xl font-bold\"><i className=\"fa-solid fa-robot mr-2\"></i>AI 健康週報</h2>\n                     {!summary && !isGenerating && (\n                         <button onClick={onGenerate} className=\"bg-white text-indigo-600 px-4 py-1.5 rounded-full text-sm font-bold shadow hover:bg-gray-100 transition\">\n                             生成分析\n                         </button>\n                     )}\n                </div>\n                \n                {isGenerating ? (\n                    <div className=\"py-8 text-center\">\n                        <i className=\"fa-solid fa-spinner fa-spin text-3xl mb-2\"></i>\n                        <p>AI 正在分析您的健康數據...</p>\n                    </div>\n                ) : summary ? (\n                    <div className=\"bg-white/10 p-4 rounded-lg text-sm leading-relaxed backdrop-blur-sm\">\n                        {summary.split('\\n').map((line, i) => <p key={i} className=\"mb-2\">{line}</p>)}\n                    </div>\n                ) : (\n                    <p className=\"opacity-80 text-sm\">點擊生成按鈕，讓 AI 為您分析本週的健康狀況並提供建議。</p>\n                )}\n            </div>\n\n            {/* Advice Table */}\n            <div className=\"bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden\">\n                <div className=\"p-4 border-b border-gray-100 bg-gray-50\">\n                    <h3 className=\"font-bold text-gray-700\">系統建議摘要</h3>\n                </div>\n                {adviceList.length === 0 ? (\n                    <div className=\"p-8 text-center text-gray-400\">\n                        <i className=\"fa-regular fa-thumbs-up text-3xl mb-2\"></i>\n                        <p>太棒了！目前沒有發現顯著的健康問題。</p>\n                    </div>\n                ) : (\n                    <div className=\"divide-y divide-gray-100\">\n                        {adviceList.map((advice, idx) => (\n                            <div key={idx} className=\"p-4 flex items-start space-x-3\">\n                                <div className={`mt-1 w-2 h-2 rounded-full flex-shrink-0 \n                                    ${advice.priority === 'High' ? 'bg-red-500' : advice.priority === 'Medium' ? 'bg-yellow-500' : 'bg-green-500'}`} \n                                />\n                                <div>\n                                    <div className=\"flex items-center space-x-2\">\n                                        <span className=\"text-xs font-bold text-gray-400 uppercase tracking-wider\">{advice.category}</span>\n                                        <h4 className=\"font-bold text-gray-800\">{advice.title}</h4>\n                                    </div>\n                                    <p className=\"text-sm text-gray-600 mt-1\">{advice.description}</p>\n                                </div>\n                            </div>\n                        ))}\n                    </div>\n                )}\n            </div>\n        </div>\n    );\n};"
            }
          ]
        }
      ]
    },
    "createdTimestamp": 1765632131542,
    "doneTimestamp": 1765632196753
  }
]